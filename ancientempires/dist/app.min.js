var AEFontStyle,__extends=this&&this.__extends||function(){var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){t[t.Bold=0]="Bold",t[t.Large=1]="Large"}(AEFontStyle=AEFontStyle||{});var AIState,AEFont=function(){function r(t,e,i,s,n){this.x=t,this.y=e,this.style=s,this.text=n||"",this.group=i,this.letters=[],this.draw()}return r.getWidth=function(t,e){return t==AEFontStyle.Bold?7*e:10*e},r.getFontIndex=function(t,e){return t==AEFontStyle.Large?48<=e&&e<=57?e-48:(console.log("Don't recognize char code "+e+" for font large"),0):65<=e&&e<90?e-65:49<=e&&e<=57?e-49+27:48==e?14:45==e?25:43==e?26:(console.log("Don't recognize char code "+e+" for font bold"),0)},r.prototype.setText=function(t){this.text=t,this.draw()},r.prototype.updatePosition=function(t,e){this.x=t,this.y=e;for(var i=0,s=this.letters;i<s.length;i++){var n=s[i];n.x=t,n.y=e,t+=n.width}},r.prototype.setVisibility=function(t){for(var e=0,i=this.letters;e<i.length;e++){i[e].visible=t}},r.prototype.draw=function(){for(var t=[],e=this.x,i=0;i<this.text.length;i++){var s,n,o=this.text.charCodeAt(i),a=r.getFontIndex(this.style,o);a<0?e+=r.getWidth(this.style,1):(s=void 0,this.style==AEFontStyle.Bold?s="chars":this.style==AEFontStyle.Large&&(s="lchars"),n=void 0,(n=0<this.letters.length?this.letters.shift():AncientEmpires.game.add.image(e,this.y,s,null,this.group)).frame=a,t.push(n),e+=n.width)}for(;0<this.letters.length;){this.letters.shift().destroy()}this.letters=t},r}(),Interaction=function(){function t(t,e,i){this.alliance=t,this.map=e,this.delegate=i}return t.prototype.isPlayer=function(){return!1},t.prototype.isActive=function(){return!!this.getCursorPosition()},t.prototype.setCursorPosition=function(t){this.cursor_position=t.copy()},t.prototype.getCursorPosition=function(){if(this.cursor_position)return this.cursor_position.copy();var t=this.map.getKingPosition(this.alliance);if(t)return t.copy();var e=this.map.getEntitiesWith(this.alliance);return 0<e.length?e[0].position:null},t.prototype.start=function(){},t.prototype.run=function(){},t.prototype.entityDidMove=function(t){},t.prototype.entityDidAnimation=function(t){},t.prototype.openMenu=function(t){},t.prototype.closeMenu=function(t){},t}(),NoAI=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.run=function(){this.delegate.nextTurn()},e}(Interaction);!function(t){t[t.None=0]="None",t[t.Select=1]="Select",t[t.Moving=2]="Moving",t[t.Action=3]="Action",t[t.Attack=4]="Attack",t[t.Raise=5]="Raise",t[t.Deselect=6]="Deselect"}(AIState=AIState||{});var EntityAnimationType,AI=function(n){function y(t,e,i){var s=n.call(this,t,e,i)||this;return s.state=AIState.None,s.pause=!1,s.test=[EntityType.Wizard,EntityType.Lizard],s}return __extends(y,n),y.getTileScore=function(t){switch(t){case Tile.Forest:case Tile.Hill:return 2;case Tile.Mountain:case Tile.Water:return 3}return 1},y.prototype.openMenu=function(t){t==InputContext.Wait&&(this.pause=!0)},y.prototype.closeMenu=function(t){t==InputContext.Wait&&(this.pause=!1)},y.prototype.entityDidMove=function(t){this.state=AIState.Action},y.prototype.entityDidAnimation=function(t){this.delegate.cursor.show(),this.state=AIState.Deselect},y.prototype.run=function(){if(this.delegate.camera_still&&this.delegate.cursor_still&&!this.pause)if(this.state==AIState.None){for(var t=0,e=this.map.entities;t<e.length;t++){if((s=e[t]).alliance==this.alliance&&s.state==EntityState.Ready){if(9==s.type){if(1!=this.map.countEntitiesWith(this.alliance,EntityState.Ready))continue;if(this.map.getTileAt(s.position)==Tile.Castle&&this.map.getAllianceAt(s.position)==s.alliance)if(this.map.countEntitiesWith(this.alliance,void 0,EntityType.Soldier)<2&&this.checkCostAndSpace(s.position,EntityType.Soldier))s=this.delegate.buyEntity(s,EntityType.Soldier);else if(0<this.test.length)this.delegate.getGoldForAlliance(this.alliance)>=AncientEmpires.ENTITIES[this.test[0]].cost&&(s=this.delegate.buyEntity(s,this.test[0]),this.test.shift());else{for(var i,s,n=[],o=1;o<AncientEmpires.ENTITIES.length;o++)1<=this.map.countEntitiesWith(this.alliance,void 0,o)&&AncientEmpires.ENTITIES[o].cost<600||this.checkCostAndSpace(s.position,o)&&n.push(o);0<n.length&&(i=n[Math.floor(Math.random()*n.length)],s=this.delegate.buyEntity(s,i))}}this.delegate.cursor_target=s.position.copy(),this.state=AIState.Select,this.entity_selected=s,this.selectEntity(s);var a=this.delegate.showRange(EntityRangeType.Move,s);a.sort(),this.soldiers=this.map.getEntitiesWith(this.alliance,void 0,EntityType.Soldier),this.nearest_house=this.map.getNearestHouseForEntity(s);for(var r=0,h=0,c=a.waypoints;h<c.length;h++){var p=c[h],l=this.map.getEntityAt(p.position);if(!l||l==s){if(!s.hasFlag(EntityFlags.CantAttackAfterMoving)||l==s)for(var u=0,g=this.map.getAttackTargets(s,p.position);u<g.length;u++){var d=g[u],y=this.getScore(s,p.position,d,null);y<=r||(r=y,this.entity_raise=null,this.entity_attack=d,this.entity_target=p.position.copy())}if(s.hasFlag(EntityFlags.CanRaise))for(var m=0,_=this.map.getRaiseTargets(s,p.position);m<_.length;m++){var d=_[m],f=this.getScore(s,p.position,null,d);f<=r||(r=f,this.entity_attack=null,this.entity_raise=d,this.entity_target=p.position.copy())}var E=this.getScore(s,p.position,null,null);E<=r||(r=E,this.entity_attack=null,this.entity_raise=null,this.entity_target=p.position.copy())}}return}}this.soldiers=null,this.delegate.nextTurn()}else switch(this.state){case AIState.Select:this.delegate.cursor_target.match(this.entity_target)?(this.delegate.moveEntity(this.selected_entity,this.entity_target,!0),this.state=AIState.Moving):this.delegate.cursor_target=this.entity_target.copy();break;case AIState.Action:if(this.entity_attack)return void(this.delegate.cursor_target.match(this.entity_attack.position)?(this.delegate.attackEntity(this.selected_entity,this.entity_attack),this.state=AIState.Attack):(this.delegate.cursor_target=this.entity_attack.position.copy(),this.delegate.cursor.hide(),this.delegate.showRange(EntityRangeType.Attack,this.selected_entity),this.map.selectTargetInRange(this.entity_attack)));if(this.entity_raise)return void(this.delegate.cursor_target.match(this.entity_raise.position)?(this.delegate.raiseEntity(this.selected_entity,this.entity_raise),this.state=AIState.Raise):(this.delegate.showRange(EntityRangeType.Raise,this.selected_entity),this.delegate.cursor_target=this.entity_raise.position.copy()));this.selected_entity.hasFlag(EntityFlags.CanOccupyHouse)&&this.map.getTileAt(this.entity_target)==Tile.House&&this.map.getAllianceAt(this.entity_target)!=this.alliance&&this.delegate.occupy(this.entity_target,this.alliance),this.state=AIState.Deselect;break;case AIState.Deselect:this.selected_entity.updateState(EntityState.Moved,!0),this.delegate.deselectEntity(!0),this.state=AIState.None}},y.prototype.selectEntity=function(t){this.selected_entity=t,this.delegate.selectEntity(t)},y.prototype.checkCostAndSpace=function(t,e){return!(this.delegate.getGoldForAlliance(this.alliance)<AncientEmpires.ENTITIES[e].cost)&&!(this.map.entity_range.calculateWaypoints(t,this.alliance,e,AncientEmpires.ENTITIES[e].mov,!0).length<2)},y.prototype.getScore=function(t,e,i,s){var n,o=0;switch(t.type){case EntityType.Soldier:this.map.getKingPosition(this.alliance)&&this.nearest_house&&(o+=(n=this.map.width+this.map.height-e.distanceTo(this.nearest_house.position))*n),y.getTileScore(this.map.getTileAt(e))<=1&&(o+=5);for(var a=0,r=this.soldiers;a<r.length;a++){var h,c=r[a];c!=t&&(o+=(h=t.getDistanceToEntity(c))*h)}this.map.getTileAt(e)!=Tile.House||this.map.getAllianceAt(e)==t.alliance||i||(o+=200);break;case EntityType.Wizard:s&&(o+=100);break;case EntityType.King:e.match(t.position)&&(o+=200)}i&&(i.shouldCounter(e)?o+=t.getPowerEstimate(e,this.map)-i.getPowerEstimate(e,this.map)+10-i.health:o+=2*t.getPowerEstimate(e,this.map),i.type==EntityType.King&&(o+=10)),o+=2*this.map.getDefAt(e,t.type);var p,l,u,g,d=this.map.getKingPosition(this.alliance==Alliance.Red?Alliance.Blue:Alliance.Red);return d&&(o+=2*(this.map.width+this.map.height-e.distanceTo(d))),this.map.getTileAt(e)==Tile.House&&this.map.getAllianceAt(e)==t.alliance&&(o+=2*(10-t.health)),t.health<5&&t.type!=EntityType.Soldier&&this.nearest_house&&(o+=(p=this.map.width+this.map.height-e.distanceTo(this.nearest_house.position))*p),2==this.map.getMap()&&this.nearest_house&&((l=Math.abs(this.nearest_house.position.x-e.x)-1)<0&&(l=0),(u=Math.abs(this.nearest_house.position.y-e.y)-3)<0&&(u=0),o+=(g=this.map.width+this.map.height-2*(l+u))*g),o+=10*t.position.distanceTo(e)/(t.data.mov-1),Math.floor(o)},y}(Interaction);!function(t){t[t.Attack=0]="Attack",t[t.Status=1]="Status",t[t.Raise=2]="Raise"}(EntityAnimationType=EntityAnimationType||{});var ScreenTransition,EntityAnimation=function(){function t(t,e,i){this.progress=0,this.current_step=-1,this.steps=t,this.acc=0,this.delegate=i,this.entity=e}return t.prototype.step=function(t,e,i){},t.prototype.run=function(t){if(this.acc+=t,!(this.acc<5)){this.acc-=5;for(var e=0;e<this.steps.length&&!(this.progress<this.steps[e]);)e++;var i=!1;e>this.current_step&&(this.current_step=e,i=!0);var s=0<this.current_step?this.progress-this.steps[this.current_step-1]:this.progress;this.progress++,this.step(i,this.current_step,s)}},t}(),AttackAnimation=function(a){function t(t,e,i,s,n){var o=a.call(this,[6,8],t,e)||this;return o.type=EntityAnimationType.Attack,o.first=n,o.attacker=s,o.group=i,o}return __extends(t,a),t.prototype.step=function(t,e,i){var s=this.entity.position.getWorldPosition();switch(e){case 0:t&&(this.image=this.group.game.add.image(s.x,s.y,"redspark",0,this.group)),this.image.frame=i%3,this.entity.setWorldPosition({x:s.x+2-i%2*4,y:s.y});break;case 1:t&&(this.image.visible=!1),this.entity.setWorldPosition({x:s.x+2-i%2*4,y:s.y});break;case 2:this.entity.setWorldPosition(this.entity.position.getWorldPosition()),this.image.destroy(),this.delegate.animationDidEnd(this)}},t}(EntityAnimation),StatusAnimation=function(o){function t(t,e,i,s){var n=o.call(this,1==s?[0,6,14]:[10,16,24],t,e)||this;return n.type=EntityAnimationType.Status,n.status=s,n.group=i,n}return __extends(t,o),t.prototype.step=function(t,e,i){var s=this.entity.position.getWorldPosition();switch(e){case 0:break;case 1:t&&(0!=this.status&&2!=this.status||(this.image2=this.group.game.add.image(s.x+4,s.y+4,"status",this.status,this.group)),this.image=this.group.game.add.image(s.x,s.y,"spark",0,this.group)),this.image.frame=i;break;case 2:this.status<0?(t&&(this.image.loadTexture("smoke",0),this.entity.updateState(EntityState.Dead,!0)),this.image.y=s.y-3*i,this.image.frame=Math.floor(i/2)):t&&this.image.destroy();break;case 3:this.status<0?this.image.destroy():0!=this.status&&2!=this.status||this.image2.destroy(),this.delegate.animationDidEnd(this),this.delegate.animationDidEnd(this)}},t}(EntityAnimation),RaiseAnimation=function(o){function t(t,e,i,s){var n=o.call(this,[8,18],t,e)||this;return n.type=EntityAnimationType.Raise,n.group=i,n.new_alliance=s,n.images=[],n}return __extends(t,o),t.prototype.step=function(t,e,i){var s=this.entity.position.getWorldPosition();switch(e){case 0:t&&(this.images.push(this.group.game.add.image(s.x-8,s.y-8,"spark",0,this.group)),this.images.push(this.group.game.add.image(s.x+8,s.y-8,"spark",0,this.group)),this.images.push(this.group.game.add.image(s.x-8,s.y+8,"spark",0,this.group)),this.images.push(this.group.game.add.image(s.x+8,s.y+8,"spark",0,this.group)));var n=8-i;this.images[0].frame=i%6,this.images[0].x=s.x-n,this.images[0].y=s.y-n,this.images[1].frame=i%6,this.images[1].x=s.x+n,this.images[1].y=s.y-n,this.images[2].frame=i%6,this.images[2].x=s.x-n,this.images[2].y=s.y+n,this.images[3].frame=i%6,this.images[3].x=s.x+n,this.images[3].y=s.y+n;break;case 1:t&&this.entity.raise(this.new_alliance);var o=-i;this.images[0].frame=(i+2)%6,this.images[0].x=s.x-o,this.images[0].y=s.y-o,this.images[1].frame=(i+2)%6,this.images[1].x=s.x+o,this.images[1].y=s.y-o,this.images[2].frame=(i+2)%6,this.images[2].x=s.x-o,this.images[2].y=s.y+o,this.images[3].frame=(i+2)%6,this.images[3].x=s.x+o,this.images[3].y=s.y+o;break;case 2:this.images[0].destroy(),this.images[1].destroy(),this.images[2].destroy(),this.images[3].destroy(),this.delegate.animationDidEnd(this)}},t}(EntityAnimation);!function(t){t[t.None=0]="None",t[t.Hide=1]="Hide",t[t.Show=2]="Show"}(ScreenTransition=ScreenTransition||{});var EntityFlags,EntityType,EntityStatus,EntityState,AttackScreen=function(){function y(t,e,i,s){this.background_graphics=t.add.graphics(0,0),this.background_graphics.fixedToCamera=!0,this.group=t.add.group(),this.group.fixedToCamera=!0,this.group.visible=!1,this.content_graphics=this.group.game.add.graphics(0,0,this.group),this.transition_mask=t.add.graphics(0,0),this.transition_mask.clear(),this.transition_mask.fixedToCamera=!0,this.group.mask=this.transition_mask,this.attacker=e,this.target=i,this.map=s,this.transition=ScreenTransition.None}return y.drawTransition=function(t,e,i,s,n){for(var o=Math.floor(s/4)+1,a=Math.floor(n/4)+1,r=e-6,h=0;h<4;h++){var c=Math.floor(t-2*h);if(c<=0)break;for(var p=void 0,l=void 0,l=r<=c?(p=o,a):(p=Math.floor(c*o/r),Math.floor(c*a/r)),u=Math.floor((o-p)/2),g=Math.floor((a-l)/2),d=h*o+u,y=0;y<4;y++){var m=y*a+g;i.drawRect(d,m,p,l)}}},y.getBackgroundPrefixForTile=function(t){switch(t){case Tile.Forest:return"woods";case Tile.Hill:return"hill";case Tile.Mountain:return"mountain";case Tile.Water:return"water";case Tile.Bridge:return"bridge";case Tile.House:case Tile.Castle:return"town"}return null},y.getNameForTile=function(t){switch(t){case Tile.Grass:case Tile.Hill:case Tile.Forest:return"grass";case Tile.Path:return"road";case Tile.Mountain:return"mountain";case Tile.Water:return"water";case Tile.Bridge:return"bridge";case Tile.House:case Tile.Castle:return"town"}return null},y.prototype.show=function(){this.transition_progress=0,this.transition=ScreenTransition.Hide},y.prototype.draw=function(){var t=this.map.getTileAt(this.attacker.position),e=this.map.getTileAt(this.target.position);this.drawBackgroundHalf(t,0),this.drawBackgroundHalf(e,1),this.group.bringToTop(this.content_graphics),this.content_graphics.beginFill(0),this.content_graphics.drawRect(Math.floor(this.group.game.width/2)-1,0,2,this.group.game.height),this.content_graphics.endFill()},y.prototype.drawBackgroundHalf=function(t,e){var i=Math.floor(this.group.game.width/2),s=this.group.game.height,n=e*i,o=y.getBackgroundPrefixForTile(t),a=0;if(null!=o){a=48;for(var r=Math.ceil(i/176),h=0;h<r;h++)this.group.game.add.sprite(n+88*h,0,o+"_bg",0,this.group)}for(var c=Math.ceil(i/24),p=Math.ceil((s-a)/24),l=0;l<c;l++)for(var u=0;u<p;u++){var g=Math.floor(10*Math.random()),d=9<=g?2:8<=g?1:0;this.group.game.add.sprite(n+24*l,a+24*u,y.getNameForTile(t),d,this.group)}},y.prototype.update=function(){if(this.transition!=ScreenTransition.None){if(this.transition==ScreenTransition.Hide?(this.background_graphics.clear(),this.background_graphics.beginFill(0),y.drawTransition(this.transition_progress,30,this.background_graphics,this.group.game.width,this.group.game.height),this.background_graphics.endFill()):(this.transition_mask.clear(),this.transition_mask.beginFill(),y.drawTransition(this.transition_progress,30,this.transition_mask,this.group.game.width,this.group.game.height),this.transition_mask.endFill(),1==this.transition_progress&&(this.group.visible=!0)),30<=this.transition_progress){var t=this.transition;return this.transition=ScreenTransition.None,void this.transitionDidEnd(t)}this.transition_progress++}},y.prototype.transitionDidEnd=function(t){t!=ScreenTransition.Show?(this.draw(),this.transition_progress=0,this.transition=ScreenTransition.Show):console.log("Finished")},y}(),Sprite=function(){function t(){}return t.prototype.init=function(t,e,i,s){void 0===s&&(s=[]),this.world_position=t,this.offset_x=0,this.offset_y=0,this.name=i,this.frames=s,this.sprite=e.game.add.sprite(this.world_position.x,this.world_position.y,this.name),this.sprite.frame=this.frames[0],e.add(this.sprite)},t.prototype.setFrames=function(t,e){void 0===e&&(e=0),this.frames=t,this.frame=e,this.sprite.frame=this.frames[this.frame%this.frames.length]},t.prototype.setOffset=function(t,e){this.offset_x=t,this.offset_y=e,this.update()},t.prototype.setFrame=function(t){t!=this.frame&&(this.frame=t,this.sprite.frame=this.frames[this.frame%this.frames.length])},t.prototype.setWorldPosition=function(t){this.world_position=t,this.update()},t.prototype.update=function(t){void 0===t&&(t=1),this.sprite.x=this.world_position.x+this.offset_x,this.sprite.y=this.world_position.y+this.offset_y},t.prototype.hide=function(){this.sprite.visible=!1},t.prototype.show=function(){this.sprite.visible=!0},t.prototype.destroy=function(){this.sprite.destroy()},t}();!function(t){t[t.None=0]="None",t[t.CanFly=1]="CanFly",t[t.WaterBoost=2]="WaterBoost",t[t.CanBuy=4]="CanBuy",t[t.CanOccupyHouse=8]="CanOccupyHouse",t[t.CanOccupyCastle=16]="CanOccupyCastle",t[t.CanRaise=32]="CanRaise",t[t.AntiFlying=64]="AntiFlying",t[t.CanPoison=128]="CanPoison",t[t.CanWisp=256]="CanWisp",t[t.CantAttackAfterMoving=512]="CantAttackAfterMoving"}(EntityFlags=EntityFlags||{}),function(t){t[t.Soldier=0]="Soldier",t[t.Archer=1]="Archer",t[t.Lizard=2]="Lizard",t[t.Wizard=3]="Wizard",t[t.Wisp=4]="Wisp",t[t.Spider=5]="Spider",t[t.Golem=6]="Golem",t[t.Catapult=7]="Catapult",t[t.Wyvern=8]="Wyvern",t[t.King=9]="King",t[t.Skeleton=10]="Skeleton"}(EntityType=EntityType||{}),function(t){t[t.None=0]="None",t[t.Poisoned=1]="Poisoned",t[t.Wisped=2]="Wisped"}(EntityStatus=EntityStatus||{}),function(t){t[t.Ready=0]="Ready",t[t.Moved=1]="Moved",t[t.Dead=2]="Dead"}(EntityState=EntityState||{});var EntityRangeType,Entity=function(n){function t(t,e,i){var s=n.call(this)||this;return s.atk_boost=0,s.def_boost=0,s.mov_boost=0,s.data=AncientEmpires.ENTITIES[t],s.alliance=e,s.type=t,s.position=i,s.death_count=0,s.health=10,s.rank=0,s.ep=0,s.status=0,s.state=EntityState.Ready,s.status_animation=-1,s}return __extends(t,n),t.prototype.init=function(t){n.prototype.init.call(this,this.position.getWorldPosition(),t,"unit_icons_"+this.alliance,[this.type,this.type+AncientEmpires.ENTITIES.length]),this.icon_moved=t.game.add.image(0,0,"chars",4,t),this.icon_moved.visible=!1,this.icon_health=t.game.add.image(0,0,"chars",0,t),this.icon_health.visible=!1},t.prototype.isDead=function(){return 0==this.health},t.prototype.hasFlag=function(t){return 0!=(this.data.flags&t)},t.prototype.getDistanceToEntity=function(t){return this.position.distanceTo(t.position)},t.prototype.shouldRankUp=function(){return this.rank<3&&this.ep>=75<<this.rank&&(this.ep=0,this.rank++,!0)},t.prototype.attack=function(t,e){var i=this.data.atk+this.atk_boost;this.type==EntityType.Archer&&t.type==EntityType.Wyvern&&(i+=2),this.type==EntityType.Wisp&&t.type==EntityType.Skeleton&&(i+=3),19<=(s=Math.floor(39*Math.random())-19+this.rank)?i+=2:17<=s?i+=1:s<=-19?i-=2:s<=-17&&--i;var s,n=t.data.def+t.def_boost;19<=(s=Math.floor(39*Math.random())-19+t.rank)?n+=2:17<=s?n+=1:s<=-19?n-=2:s<=-17&&--n;var o=Math.floor((i-(n+e.getDefAt(t.position,t.type))*(2/3))*this.health/10);o>t.health&&(o=t.health),t.setHealth(t.health-o),this.ep+=(t.data.atk+t.data.def)*o},t.prototype.updateStatus=function(){this.atk_boost=0,this.def_boost=0,this.mov_boost=0,this.status&EntityStatus.Poisoned&&(this.atk_boost--,this.def_boost--,this.mov_boost--),this.status&EntityStatus.Wisped&&this.atk_boost++},t.prototype.setStatus=function(t){this.status|=t,this.updateStatus()},t.prototype.clearStatus=function(t){this.status&=~t,this.updateStatus()},t.prototype.getPowerEstimate=function(t,e){return Math.floor((this.rank+this.data.atk+this.data.def+e.getDefAt(t,this.type))*this.health)},t.prototype.updateState=function(t,e){(this.state=t)==EntityState.Dead?(this.sprite.loadTexture("tombstone",0),this.setFrames([0])):(this.sprite.loadTexture("unit_icons_"+this.alliance,this.type),this.setFrames([this.type,this.type+AncientEmpires.ENTITIES.length]));var i=e&&t==EntityState.Moved;this.icon_moved.x=this.sprite.x+AncientEmpires.TILE_SIZE-7,this.icon_moved.y=this.sprite.y+AncientEmpires.TILE_SIZE-7,this.icon_moved.visible=i,this.icon_moved.bringToTop()},t.prototype.startAnimation=function(t){this.animation=t},t.prototype.move=function(t,e,i){this.path={progress:0,line:e,delegate:i,target:t.copy()}},t.prototype.update=function(t){var e,i;void 0===t&&(t=1),n.prototype.update.call(this,t),this.path?(this.path.progress+=t,0<this.path.line.length&&this.path.progress>=this.path.line[0].length*AncientEmpires.TILE_SIZE&&(this.path.progress-=this.path.line[0].length*AncientEmpires.TILE_SIZE,this.path.line.shift()),0<this.path.line.length?(e=new Pos(0,0).move(this.path.line[0].direction),this.world_position.x=this.path.line[0].position.x*AncientEmpires.TILE_SIZE+e.x*this.path.progress,this.world_position.y=this.path.line[0].position.y*AncientEmpires.TILE_SIZE+e.y*this.path.progress):(this.position=this.path.target,this.world_position=this.path.target.getWorldPosition(),console.log("test"+this.path.target),i=this.path.delegate,this.path=null,i.entityDidMove(this))):this.animation&&this.animation.run(t),this.icon_health.x=this.sprite.x,this.icon_health.y=this.sprite.y+AncientEmpires.TILE_SIZE-7},t.prototype.setHealth=function(t){9<(this.health=t)||t<1?this.icon_health.visible=!1:(this.icon_health.visible=!0,this.icon_health.frame=t-1+27,this.icon_health.x=this.sprite.x,this.icon_health.y=this.sprite.y+AncientEmpires.TILE_SIZE-7)},t.prototype.raise=function(t){this.type=EntityType.Skeleton,this.alliance=t,this.rank=0,this.ep=0,this.death_count=0,this.setHealth(10),this.clearStatus(EntityStatus.Poisoned),this.clearStatus(EntityStatus.Wisped),this.updateState(EntityState.Moved,!0)},t.prototype.getMovement=function(){return this.data.mov+this.mov_boost},t.prototype.shouldCounter=function(t){return 0<this.health&&this.position.distanceTo(t)<2&&this.data.min<2},t.prototype.destroy=function(){this.icon_health.destroy(),this.icon_moved.destroy(),n.prototype.destroy.call(this)},t.prototype.export=function(){return{type:this.type,alliance:this.alliance,x:this.position.x,y:this.position.y,rank:this.rank,ep:this.ep,state:this.state,status:this.status,health:this.health,death_count:this.death_count}},t}(Sprite),EntityManager=function(){function t(t,e,i,s,n,o){this.map=t,this.entity_group=e,this.selection_group=i,this.interaction_group=s,this.anim_group=n,this.delegate=o,this.selection_graphics=i.game.add.graphics(0,0,i),this.interaction_graphics=s.game.add.graphics(0,0,s),this.anim_idle_state=0,this.map.entity_range.init(this.interaction_group);for(var a=0,r=this.map.entities;a<r.length;a++){var h=r[a];this.createEntity(h)}}return t.prototype.selectEntity=function(t){this.entity_group.remove(t.sprite),this.entity_group.remove(t.icon_health),this.interaction_group.add(t.sprite),this.interaction_group.add(t.icon_health)},t.prototype.deselectEntity=function(t){this.interaction_group.remove(t.sprite),this.interaction_group.remove(t.icon_health),this.entity_group.addAt(t.icon_health,0),this.entity_group.addAt(t.sprite,0)},t.prototype.showRange=function(){this.show_range=!0,this.map.entity_range.draw(this.selection_graphics)},t.prototype.hideRange=function(){this.show_range=!1,this.map.entity_range.clear(this.selection_graphics,this.interaction_graphics)},t.prototype.update=function(t,e,i){for(var s=0,n=this.map.entities;s<n.length;s++){var o=n[s];this.anim_idle_state!=i&&o.setFrame(this.anim_idle_state),o.update(t)}this.anim_idle_state=i,this.show_range&&this.map.entity_range.update(t,e,i,this.selection_graphics,this.interaction_graphics)},t.prototype.animationDidEnd=function(t){switch(t.entity.animation=null,t.type){case EntityAnimationType.Attack:var e=t;if(e.first&&e.entity.shouldCounter(e.attacker.position))return void this.attackEntity(e.entity,e.attacker,!1);var i=e.first?e.attacker:e.entity,s=e.first?e.entity:e.attacker;i.hasFlag(EntityFlags.CanPoison)&&(s.setStatus(EntityStatus.Poisoned),s.status_animation=0),i.shouldRankUp()&&(i.status_animation=2),s.shouldRankUp()&&(s.status_animation=2),(i.isDead()||0<=i.status_animation)&&i.startAnimation(new StatusAnimation(i,this,this.anim_group,i.isDead()?-1:i.status_animation)),(s.isDead()||0<=s.status_animation)&&s.startAnimation(new StatusAnimation(s,this,this.anim_group,s.isDead()?-1:s.status_animation)),this.delegate.entityDidAnimation(e.entity);break;case EntityAnimationType.Status:t.entity.status_animation=-1;break;case EntityAnimationType.Raise:this.delegate.entityDidAnimation(t.entity)}},t.prototype.showWisped=function(){for(var t=0,e=this.map.entities;t<e.length;t++){var i=e[t];i.status==EntityStatus.Wisped&&(i.animation||i.startAnimation(new StatusAnimation(i,this,this.anim_group,1)))}},t.prototype.attackEntity=function(t,e,i){void 0===i&&(i=!0),t.attack(e,this.map),e.startAnimation(new AttackAnimation(e,this,this.anim_group,t,i))},t.prototype.raiseEntity=function(t,e){e.startAnimation(new RaiseAnimation(e,this,this.anim_group,t.alliance))},t.prototype.createEntity=function(t){t.init(this.entity_group)},t}();!function(t){t[t.None=0]="None",t[t.Move=1]="Move",t[t.Attack=2]="Attack",t[t.Raise=3]="Raise"}(EntityRangeType=EntityRangeType||{});var FrameAnimation,EntityRange=function(){function u(t){this.map=t,this.type=EntityRangeType.None}return u.findPositionInList=function(t,e){for(var i=0,s=e;i<s.length;i++){var n=s[i];if(n.position.match(t))return n}return null},u.getLineToWaypoint=function(t){for(var e=[];null!=t.parent;){var i=t,s=(t=t.parent).position.getDirectionTo(i.position);0<e.length&&e[0].direction==s?(e[0].position=t.position,e[0].length++):e.unshift({position:t.position,direction:s,length:1})}return e},u.prototype.init=function(t){this.extra_cursor=new Sprite,this.extra_cursor.init({x:0,y:0},t,"cursor",[4]),this.extra_cursor.hide()},u.prototype.getWaypointAt=function(t){return u.findPositionInList(t,this.waypoints)},u.prototype.sort=function(){this.waypoints.sort(function(t,e){return t.position.x==e.position.x?t.position.y-e.position.y:t.position.x-e.position.x})},u.prototype.createRange=function(t,e,i){switch(this.type=t,this.targets_x=i,this.targets_y=null,this.target=null,this.range_lighten=!1,this.range_progress=100,this.line_end_position=null,this.line_slow=0,this.line_offset=0,t){case EntityRangeType.Raise:this.waypoints=[{position:e.position.copy(Direction.Up),cost:0,form:Direction.All,parent:null},{position:e.position.copy(Direction.Right),cost:0,form:Direction.All,parent:null},{position:e.position.copy(Direction.Down),cost:0,form:Direction.All,parent:null},{position:e.position.copy(Direction.Left),cost:0,form:Direction.All,parent:null}],this.extra_cursor.hide();break;case EntityRangeType.Attack:var s=e.data.min,n=e.data.max;this.waypoints=this.calculateWaypoints(e.position,e.alliance,e.type,n,!1);for(var o=this.waypoints.length-1;0<=o;o--){this.waypoints[o].cost<s&&this.waypoints.splice(o,1)}this.addForm(),this.extra_cursor.setFrames([2,3]),this.extra_cursor.setOffset(-1,-1),this.extra_cursor.show();break;case EntityRangeType.Move:this.waypoints=this.calculateWaypoints(e.position,e.alliance,e.type,e.getMovement(),!e.hasFlag(EntityFlags.CanFly)),this.addForm(),this.extra_cursor.setFrames([4]),this.extra_cursor.setOffset(-1,-4),this.extra_cursor.show()}},u.prototype.nextTargetInRange=function(t){if(this.targets_x.length<1)return null;if(this.targets_y||this.sortTargets(),t==Direction.None)return this.target;var e=new Pos(0,0).move(t);if(0!=e.x){var i=this.targets_x.indexOf(this.target);return(i+=e.x)<0?i=this.targets_x.length-1:i>=this.targets_x.length&&(i=0),this.target=this.targets_x[i],this.target}var s=this.targets_y.indexOf(this.target);return(s+=e.y)<0?s=this.targets_y.length-1:s>=this.targets_y.length&&(s=0),this.target=this.targets_y[s],this.target},u.prototype.selectTarget=function(t){return!!this.getWaypointAt(t.position)&&(this.target=t,!0)},u.prototype.sortTargets=function(){this.targets_y=this.targets_x.slice(),this.targets_x.sort(function(t,e){return t.position.x==e.position.x?t.position.y-e.position.y:t.position.x-e.position.x}),this.targets_y.sort(function(t,e){return t.position.y==e.position.y?t.position.x-e.position.x:t.position.y-e.position.y}),this.target=0<this.targets_x.length?this.targets_x[this.targets_x.length-1]:null},u.prototype.draw=function(t){var e;switch(this.type){case EntityRangeType.Move:case EntityRangeType.Raise:e=16777215;break;case EntityRangeType.Attack:e=16711680}t.clear(),t.beginFill(e);for(var i=0,s=this.waypoints;i<s.length;i++){var n=s[i],o=n.position.getWorldPosition();0!=(n.form&Direction.Up)&&t.drawRect(o.x,o.y,AncientEmpires.TILE_SIZE,4),0!=(n.form&Direction.Right)&&t.drawRect(o.x+AncientEmpires.TILE_SIZE-4,o.y,4,AncientEmpires.TILE_SIZE),0!=(n.form&Direction.Down)&&t.drawRect(o.x,o.y+AncientEmpires.TILE_SIZE-4,AncientEmpires.TILE_SIZE,4),0!=(n.form&Direction.Left)&&t.drawRect(o.x,o.y,4,AncientEmpires.TILE_SIZE)}t.endFill()},u.prototype.update=function(t,e,i,s,n){if(this.type!=EntityRangeType.None){var o;if(this.range_lighten?(this.range_progress+=t,100<=this.range_progress&&(this.range_progress=100,this.range_lighten=!1)):(this.range_progress-=t,this.range_progress<=40&&(this.range_progress=40,this.range_lighten=!0)),this.extra_cursor.setFrame(i),e.match(this.line_end_position)||(this.line_end_position=e.copy(),(o=this.getWaypointAt(e))&&(this.extra_cursor.setWorldPosition(e.getWorldPosition()),this.line=u.getLineToWaypoint(o))),this.type==EntityRangeType.Move&&(this.line_slow+=t,5<=this.line_slow&&(this.line_slow-=5,--this.line_offset,this.line_offset<0&&(this.line_offset=AncientEmpires.LINE_SEGMENT_LENGTH+AncientEmpires.LINE_SEGMENT_SPACING-1),this.line))){n.clear(),n.beginFill(16777215);for(var a=0,r=this.line;a<r.length;a++){var h=r[a];this.drawSegment(n,h,this.line_offset),this.line_offset=(this.line_offset+h.length*AncientEmpires.TILE_SIZE)%(AncientEmpires.LINE_SEGMENT_LENGTH+AncientEmpires.LINE_SEGMENT_SPACING)}n.endFill()}var c=this.range_progress/100*255|0;s.tint=c<<16|c<<8|c}},u.prototype.clear=function(t,e){this.type=EntityRangeType.None,this.waypoints=[],this.extra_cursor.hide(),t.clear(),e.clear()},u.prototype.calculateWaypoints=function(t,e,i,s,n){for(var o=[{position:t,cost:n?1:0,form:0,parent:null}],a=[];0<o.length;){var r=o.shift();a.push(r);for(var h=0,c=this.map.getAdjacentPositionsAt(r.position);h<c.length;h++){var p=c[h];this.checkPosition(p,r,o,a,s,n,e,i)}}return a},u.prototype.checkPosition=function(t,e,i,s,n,o,a,r){if(u.findPositionInList(t,s))return!1;if(o){var h=this.map.getEntityAt(t);if(h&&!h.isDead()&&h.alliance!=a)return!1}var c=1;o&&(c=this.map.getCostAt(t,r));var p=e.cost+c;if(n<p)return!1;var l=u.findPositionInList(t,i);return l?!(l.cost<=p)&&(l.cost=p,l.parent=e,!0):(i.push({position:t,parent:e,form:0,cost:p}),!0)},u.prototype.addForm=function(){for(var t=0,e=this.waypoints;t<e.length;t++){var i=e[t];(i.form=0)<i.position.y&&!this.getWaypointAt(i.position.copy(Direction.Up))&&(i.form+=1),i.position.x<this.map.width-1&&!this.getWaypointAt(i.position.copy(Direction.Right))&&(i.form+=2),i.position.y<this.map.height-1&&!this.getWaypointAt(i.position.copy(Direction.Down))&&(i.form+=4),0<i.position.x&&!this.getWaypointAt(i.position.copy(Direction.Left))&&(i.form+=8)}},u.prototype.drawSegment=function(t,e,i){for(var s=e.length*AncientEmpires.TILE_SIZE,n=(e.position.x+.5)*AncientEmpires.TILE_SIZE,o=(e.position.y+.5)*AncientEmpires.TILE_SIZE;0<s;){var a=AncientEmpires.LINE_SEGMENT_LENGTH;switch(0<i&&(a-=i,i=0),s<a&&(a=s),e.direction){case Direction.Up:0<a&&t.drawRect(n-AncientEmpires.LINE_SEGMENT_WIDTH/2,o-a,AncientEmpires.LINE_SEGMENT_WIDTH,a),o-=a+AncientEmpires.LINE_SEGMENT_SPACING;break;case Direction.Right:0<a&&t.drawRect(n,o-AncientEmpires.LINE_SEGMENT_WIDTH/2,a,AncientEmpires.LINE_SEGMENT_WIDTH),n+=a+AncientEmpires.LINE_SEGMENT_SPACING;break;case Direction.Down:0<a&&t.drawRect(n-AncientEmpires.LINE_SEGMENT_WIDTH/2,o,AncientEmpires.LINE_SEGMENT_WIDTH,a),o+=a+AncientEmpires.LINE_SEGMENT_SPACING;break;case Direction.Left:0<a&&t.drawRect(n-a,o-AncientEmpires.LINE_SEGMENT_WIDTH/2,a,AncientEmpires.LINE_SEGMENT_WIDTH),n-=a+AncientEmpires.LINE_SEGMENT_SPACING}s-=a+AncientEmpires.LINE_SEGMENT_SPACING}},u}();!function(t){t[t.None=0]="None",t[t.Show=1]="Show",t[t.Hide=2]="Hide",t[t.Change=4]="Change",t[t.Wire=8]="Wire",t[t.Destroy=16]="Destroy",t[t.Update=32]="Update"}(FrameAnimation=FrameAnimation||{});var Key,Frame=function(){function l(){this.reuse_tiles=[]}return l.getRect=function(t,e,i,s){return{x:t,y:e,width:i,height:s}},l.copyRect=function(t){return{x:t.x,y:t.y,width:t.width,height:t.height}},l.getTileForDirection=function(t){switch(t){case Direction.Up:return 4;case Direction.Up|Direction.Right:return 1;case Direction.Right:return 7;case Direction.Right|Direction.Down:return 3;case Direction.Down:return 5;case Direction.Down|Direction.Left:return 2;case Direction.Left:return 6}return 0},l.prototype.initialize=function(t,e,i,s,n,o){this.align=s,this.animation_direction=void 0!==o?o:s,this.border=n,this.group=i,this.border_group=this.group.game.add.group(),this.group.add(this.border_group),this.border_group.visible=!1,this.border_graphics=this.group.game.add.graphics(0,0,this.border_group),this.content_group=this.group.game.add.group(),this.group.add(this.content_group),this.content_group.visible=!1,this.content_graphics=this.group.game.add.graphics(0,0,this.content_group),this.game_width=this.group.game.width,this.game_height=this.group.game.height,this.width=t,this.height=e,this.animation=FrameAnimation.None,this.current=this.getRetractedRect()},l.prototype.show=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=0),this.animation=FrameAnimation.None,this.target=this.getAlignmentRect(e),t?(this.animation=FrameAnimation.Show,this.animation_direction==Direction.None&&(this.animation|=FrameAnimation.Wire),this.calculateSpeed()):this.current=l.copyRect(this.target),this.updateOffset(),this.border_group.visible=!0,0!=(this.animation&FrameAnimation.Wire)?(this.removeFrame(),this.content_group.visible=!1):(this.drawFrame(this.width,this.height),this.content_group.visible=!0)},l.prototype.hide=function(t,e,i){if(void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=!1),this.animation=FrameAnimation.None,this.target=this.getRetractedRect(),!t)return this.current=l.copyRect(this.target),this.border_group.visible=!1,this.content_group.visible=!1,this.removeTiles(),this.updateOffset(),void(e&&this.destroy());this.animation=FrameAnimation.Hide,e&&(this.animation|=FrameAnimation.Destroy),i&&(this.animation|=FrameAnimation.Update),this.animation_direction==Direction.None&&(this.animation|=FrameAnimation.Wire,this.content_group.visible=!1,this.removeFrame()),this.calculateSpeed()},l.prototype.updateSize=function(t,e,i){if(void 0===i&&(i=!1),this.width!=t||this.height!=e){if(0!=(this.animation&FrameAnimation.Update))return this.width=t,void(this.height=e);if(this.animation=FrameAnimation.None,!i)return this.width=t,this.height=e,this.target=this.getAlignmentRect(),this.current=l.copyRect(this.target),this.updateOffset(),void this.drawFrame(t,e);var s=this.width,n=this.height;this.width=t,this.height=e,this.animation=FrameAnimation.Change,this.animation_direction==Direction.None?this.animation|=FrameAnimation.Wire:(t=Math.max(t,s),e=Math.max(e,n),this.current.width=t,this.current.height=e),this.target=this.getAlignmentRect(),0!=(this.align&Direction.Left)&&(this.current.x-=t-s,this.target.x-=t-this.width),0!=(this.align&Direction.Up)&&(this.current.y-=e-n,this.target.y-=e-this.height),this.updateOffset(),0!=(this.animation&FrameAnimation.Wire)?this.removeFrame():this.drawFrame(t,e),this.calculateSpeed()}},l.prototype.updateDirections=function(t,e,i,s){void 0===s&&(s=!1),this.new_align===t&&this.new_border==e&&this.new_animation_direction==i&&this.new_animate==s||(this.new_align=t,this.new_border=e,this.new_animation_direction=i,this.new_animate=s,this.hide(!0,!1,!0))},l.prototype.update=function(t){if(this.animation!=FrameAnimation.None){var e=this.addGain("x",t),i=this.addGain("y",t),s=!0,n=!0;if(0!=(this.animation&FrameAnimation.Wire)&&(s=this.addGain("width",t),n=this.addGain("height",t)),e&&i&&s&&n){if(this.animationDidEnd(this.animation),0!=(this.animation&FrameAnimation.Wire)&&(this.border_graphics.clear(),0==(this.animation&FrameAnimation.Hide)&&(this.drawFrame(this.width,this.height),this.content_group.visible=!0)),0!=(this.animation&FrameAnimation.Change)&&(this.target.width=this.width,this.target.height=this.height,0!=(this.align&Direction.Left)&&(this.target.x=0),0!=(this.align&Direction.Up)&&(this.target.y=0),this.current=l.copyRect(this.target),this.updateOffset(),this.drawFrame(this.width,this.height)),0!=(this.animation&FrameAnimation.Hide)){if(0!=(this.animation&FrameAnimation.Destroy))return void this.destroy();if(0!=(this.animation&FrameAnimation.Update))return void this.applyDirections();this.hide()}this.animation=FrameAnimation.None}0!=(this.animation&FrameAnimation.Wire)&&(this.border_graphics.clear(),this.border_graphics.lineStyle(1,16777215),this.border_graphics.drawRect(0,0,this.current.width,this.current.height)),this.updateOffset()}},l.prototype.destroy=function(){this.delegate&&this.delegate.frameWillDestroy(this),this.border_group.destroy(!0),this.content_group.destroy(!0)},l.prototype.animationDidEnd=function(t){},l.prototype.applyDirections=function(){this.align=this.new_align,this.border=this.new_border,this.animation_direction=this.new_animation_direction,this.current=this.getRetractedRect(),this.show(this.new_animate)},l.prototype.getAlignmentRect=function(t){void 0===t&&(t=0);var e=l.getRect(0,0,this.width,this.height);return 0!=(this.align&Direction.Left)?e.x=0:0!=(this.align&Direction.Right)?e.x=this.game_width-this.width:e.x=Math.floor((this.game_width-this.width)/2),0<t?e.y=t:0!=(this.align&Direction.Up)?e.y=0:0!=(this.align&Direction.Down)?e.y=this.game_height-this.height:e.y=Math.floor((this.game_height-this.height)/2),e},l.prototype.getRetractedRect=function(){if(this.animation_direction==Direction.None)return l.getRect(Math.floor(this.game_width/2),Math.floor(this.game_height/2),0,0);var t=this.getAlignmentRect();return 0!=(this.animation_direction&Direction.Left)&&(t.x=-this.width),0!=(this.animation_direction&Direction.Right)&&(t.x=this.game_width),0!=(this.animation_direction&Direction.Up)&&(t.y=-this.height),0!=(this.animation_direction&Direction.Down)&&(t.y=this.game_height),t},l.prototype.updateOffset=function(){var t=this.current.x,e=this.current.y,i=0,s=0;0!=(this.border&Direction.Left)&&(i=6),0!=(this.border&Direction.Up)&&(s=6),this.border_group.x=t,this.border_group.y=e,this.content_group.x=t+i,this.content_group.y=e+s},l.prototype.drawFrame=function(t,e){var i=t,s=e;0!=(this.border&Direction.Left)&&(i-=6),0!=(this.border&Direction.Right)&&(i-=6),0!=(this.border&Direction.Up)&&(s-=6),0!=(this.border&Direction.Down)&&(s-=6);var n=Math.ceil(t/l.BORDER_SIZE)-2,o=Math.ceil(e/l.BORDER_SIZE)-2;this.content_graphics.clear(),this.content_graphics.lineStyle(0),this.content_graphics.beginFill(13549221),this.content_graphics.drawRect(0,0,i,s),this.content_graphics.endFill();for(var a=[],r=l.BORDER_SIZE,h=0;h<n;h++)this.border&Direction.Up&&a.push(this.drawBorderTile(r,0,Direction.Up)),this.border&Direction.Down&&a.push(this.drawBorderTile(r,e-l.BORDER_SIZE,Direction.Down)),r+=l.BORDER_SIZE;for(var c=l.BORDER_SIZE,p=0;p<o;p++)this.border&Direction.Left&&a.push(this.drawBorderTile(0,c,Direction.Left)),this.border&Direction.Right&&a.push(this.drawBorderTile(t-l.BORDER_SIZE,c,Direction.Right)),c+=l.BORDER_SIZE;0!=(this.border&(Direction.Up|Direction.Left))&&a.push(this.drawBorderTile(0,0,this.border&(Direction.Up|Direction.Left))),0!=(this.border&(Direction.Up|Direction.Right))&&a.push(this.drawBorderTile(t-l.BORDER_SIZE,0,this.border&(Direction.Up|Direction.Right))),0!=(this.border&(Direction.Down|Direction.Left))&&a.push(this.drawBorderTile(0,e-l.BORDER_SIZE,this.border&(Direction.Down|Direction.Left))),0!=(this.border&(Direction.Down|Direction.Right))&&a.push(this.drawBorderTile(t-l.BORDER_SIZE,e-l.BORDER_SIZE,this.border&(Direction.Down|Direction.Right))),this.removeTiles(),this.reuse_tiles=a},l.prototype.removeFrame=function(){this.content_graphics.clear(),this.removeTiles()},l.prototype.drawBorderTile=function(t,e,i){var s;return 0<this.reuse_tiles.length?((s=this.reuse_tiles.shift()).bringToTop(),s.x=t,s.y=e):s=this.group.game.add.image(t,e,"menu",null,this.border_group),s.frame=l.getTileForDirection(i),s},l.prototype.addGain=function(t,e){if(0==this.speed[t])return!0;this.acc[t]+=this.speed[t]*e;var i=Math.floor(this.acc[t]);return this.current[t]+=i,this.acc[t]-=i,(i<0&&this.current[t]<this.target[t]||0<i&&this.current[t]>this.target[t])&&(this.current[t]=this.target[t],!0)},l.prototype.calculateSpeed=function(){this.speed=l.getRect((this.target.x-this.current.x)/l.ANIM_STEPS,(this.target.y-this.current.y)/l.ANIM_STEPS,(this.target.width-this.current.width)/l.ANIM_STEPS,(this.target.height-this.current.height)/l.ANIM_STEPS),this.acc=l.getRect(0,0,0,0)},l.prototype.removeTiles=function(){for(;0<this.reuse_tiles.length;){this.reuse_tiles.shift().destroy()}},l.BORDER_SIZE=24,l.ANIM_STEPS=15,l}(),FrameManager=function(){function t(t){this.group=t,this.frames=[]}return t.prototype.addFrame=function(t){(t.delegate=this).frames.push(t)},t.prototype.removeFrame=function(t){for(var e=0;e<this.frames.length;e++)if(t==this.frames[e]){this.frames.splice(e,1);break}},t.prototype.update=function(t){for(var e=0,i=this.frames;e<i.length;e++){i[e].update(t)}},t.prototype.frameWillDestroy=function(t){this.removeFrame(t)},t}();!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Right=2]="Right",t[t.Down=4]="Down",t[t.Left=8]="Left",t[t.Enter=16]="Enter",t[t.Esc=32]="Esc"}(Key=Key||{});var Tile,Input=function(){function t(t){this.all_keys=Key.None,this.key_up=t.keyboard.addKey(Phaser.Keyboard.UP),this.key_down=t.keyboard.addKey(Phaser.Keyboard.DOWN),this.key_right=t.keyboard.addKey(Phaser.Keyboard.RIGHT),this.key_left=t.keyboard.addKey(Phaser.Keyboard.LEFT),this.key_enter=t.keyboard.addKey(Phaser.Keyboard.ENTER),this.key_esc=t.keyboard.addKey(Phaser.Keyboard.ESC)}return t.prototype.isKeyPressed=function(t){return 0!=(this.all_keys&t)},t.prototype.clearKeyPressed=function(t){this.all_keys&=~t},t.prototype.update=function(){var t=Key.None;t|=this.updateKey(Key.Up,this.key_up.isDown),t|=this.updateKey(Key.Right,this.key_right.isDown),t|=this.updateKey(Key.Down,this.key_down.isDown),t|=this.updateKey(Key.Left,this.key_left.isDown),t|=this.updateKey(Key.Enter,this.key_enter.isDown),t|=this.updateKey(Key.Esc,this.key_esc.isDown),this.last_keys=t},t.prototype.setKey=function(t,e){this.all_keys^=(-e^this.all_keys)&t},t.prototype.wasKeyPressed=function(t){return 0!=(this.last_keys&t)},t.prototype.updateKey=function(t,e){return e!=this.wasKeyPressed(t)&&this.setKey(t,e),e?t:0},t}(),MiniMap=function(n){function t(t,e,i){var s=n.call(this)||this;return s.map=t,s.menu_delegate=i,s.slow=0,s.units_visible=!0,s.initialize(t.width*AncientEmpires.MINI_SIZE+12,t.height*AncientEmpires.MINI_SIZE+12,e,Direction.None,Direction.All,Direction.None),s.drawContent(),s}return __extends(t,n),t.prototype.show=function(t){void 0===t&&(t=!1),this.menu_delegate&&this.menu_delegate.openMenu(InputContext.Ack),n.prototype.show.call(this,t)},t.prototype.hide=function(t,e,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=!1),this.menu_delegate&&this.menu_delegate.closeMenu(InputContext.Ack),n.prototype.hide.call(this,t,e,i)},t.prototype.update=function(t){if(n.prototype.update.call(this,t),this.slow+=t,30<=this.slow){this.slow-=30,this.units_visible=!this.units_visible;for(var e=0,i=this.entities;e<i.length;e++){i[e].visible=this.units_visible}}},t.prototype.drawContent=function(){for(var t=0;t<this.map.width;t++)for(var e=0;e<this.map.height;e++){var i=this.getTileIndexAt(new Pos(t,e));this.group.game.add.image(t*AncientEmpires.MINI_SIZE,e*AncientEmpires.MINI_SIZE,"stiles0",i,this.content_group)}this.entities=[];for(var s=0,n=this.map.entities;s<n.length;s++){var o=n[s],a=this.group.game.add.image(o.position.x*AncientEmpires.MINI_SIZE,o.position.y*AncientEmpires.MINI_SIZE,"unit_icons_s_"+o.alliance,o.type,this.content_group);this.entities.push(a)}},t.prototype.getTileIndexAt=function(t){var e=this.map.getTileAt(t);switch(e){case Tile.Path:return 0;case Tile.Grass:return 1;case Tile.Forest:return 2;case Tile.Hill:return 3;case Tile.Mountain:return 4;case Tile.Water:return 5;case Tile.Bridge:return 6;case Tile.House:case Tile.Castle:var i=this.map.getAllianceAt(t);return(e==Tile.Castle?8:7)+2*i}return 0},t}(Frame),Player=function(o){function t(t,e,i,s){var n=o.call(this,t,e,i)||this;return n.keys=s,n.context=[InputContext.Map],n}return __extends(t,o),t.prototype.isPlayer=function(){return!0},t.prototype.start=function(){this.keys.all_keys=Key.None},t.prototype.run=function(){if(this.keys.update(),this.keys.all_keys!=Key.None)switch(this.context[this.context.length-1]){case InputContext.Map:var t,e=this.delegate.cursor.world_position.x%24==0&&this.delegate.cursor.world_position.y%24==0;this.keys.isKeyPressed(Key.Up)&&e&&0<this.delegate.cursor_target.y?this.delegate.cursor_target.move(Direction.Up):this.keys.isKeyPressed(Key.Right)&&e&&this.delegate.cursor_target.x<this.map.width-1?this.delegate.cursor_target.move(Direction.Right):this.keys.isKeyPressed(Key.Down)&&e&&this.delegate.cursor_target.y<this.map.height-1?this.delegate.cursor_target.move(Direction.Down):this.keys.isKeyPressed(Key.Left)&&e&&0<this.delegate.cursor_target.x?this.delegate.cursor_target.move(Direction.Left):this.keys.isKeyPressed(Key.Enter)?(this.keys.clearKeyPressed(Key.Enter),this.pickPosition(this.delegate.cursor_target)):this.keys.isKeyPressed(Key.Esc)&&(this.keys.clearKeyPressed(Key.Esc),n=this.selected_entity,this.deselectEntity(!1),n&&n.position.match(this.map.getKingPosition(this.alliance))&&n.data.cost<=1e3&&(t=this.delegate.getGoldForAlliance(this.alliance),this.delegate.setGoldForAlliance(this.alliance,t+n.data.cost),this.map.removeEntity(n)));break;case InputContext.Options:var i;this.keys.isKeyPressed(Key.Up)?(this.keys.clearKeyPressed(Key.Up),this.options_menu.prev()):this.keys.isKeyPressed(Key.Down)?(this.keys.clearKeyPressed(Key.Down),this.options_menu.next()):this.keys.isKeyPressed(Key.Enter)?(this.keys.clearKeyPressed(Key.Enter),i=this.options_menu.getSelected(),this.context.pop(),this.options_menu.hide(!0,!0),this.options_menu=null,this.selectOption(i)):this.keys.isKeyPressed(Key.Esc)&&(this.keys.clearKeyPressed(Key.Esc),this.context.pop(),this.options_menu.hide(!0,!0),this.options_menu=null,this.selectOption(Action.CANCEL));break;case InputContext.Selection:this.keys.isKeyPressed(Key.Up)&&0<this.delegate.cursor_target.y?(this.keys.clearKeyPressed(Key.Up),n=this.map.nextTargetInRange(Direction.Up),this.delegate.cursor_target=n.position.copy()):this.keys.isKeyPressed(Key.Right)&&this.delegate.cursor_target.x<this.map.width-1?(this.keys.clearKeyPressed(Key.Right),n=this.map.nextTargetInRange(Direction.Right),this.delegate.cursor_target=n.position.copy()):this.keys.isKeyPressed(Key.Down)&&this.delegate.cursor_target.y<this.map.height-1?(this.keys.clearKeyPressed(Key.Down),n=this.map.nextTargetInRange(Direction.Down),this.delegate.cursor_target=n.position.copy()):this.keys.isKeyPressed(Key.Left)&&0<this.delegate.cursor_target.x?(this.keys.clearKeyPressed(Key.Left),n=this.map.nextTargetInRange(Direction.Left),this.delegate.cursor_target=n.position.copy()):this.keys.isKeyPressed(Key.Enter)?(this.keys.clearKeyPressed(Key.Enter),this.delegate.cursor.show(),this.context.pop(),n=this.map.nextTargetInRange(Direction.None),this.pickEntity(n)):this.keys.isKeyPressed(Key.Esc)&&(this.keys.clearKeyPressed(Key.Esc),this.delegate.cursor_target=this.selected_entity.position.copy(),this.delegate.cursor.show(),this.context.pop(),n=this.selected_entity,this.delegate.deselectEntity(!1),this.selectEntity(n));break;case InputContext.Shop:var s,n;this.keys.isKeyPressed(Key.Up)?(this.keys.clearKeyPressed(Key.Up),this.shop_units.prev(!0),this.shop_info.updateContent(this.shop_units.getSelected())):this.keys.isKeyPressed(Key.Right)?(this.keys.clearKeyPressed(Key.Right),this.shop_units.next(!1),this.shop_info.updateContent(this.shop_units.getSelected())):this.keys.isKeyPressed(Key.Down)?(this.keys.clearKeyPressed(Key.Down),this.shop_units.next(!0),this.shop_info.updateContent(this.shop_units.getSelected())):this.keys.isKeyPressed(Key.Left)?(this.keys.clearKeyPressed(Key.Left),this.shop_units.prev(!1),this.shop_info.updateContent(this.shop_units.getSelected())):this.keys.isKeyPressed(Key.Enter)?(this.keys.clearKeyPressed(Key.Enter),s=this.shop_units.getSelected(),(n=this.delegate.buyEntity(this.selected_entity,s))&&(this.deselectEntity(!1),this.closeShop(),this.selectEntity(n))):this.keys.isKeyPressed(Key.Esc)&&(this.keys.clearKeyPressed(Key.Esc),this.deselectEntity(!1),this.closeShop());break;case InputContext.Ack:this.keys.isKeyPressed(Key.Enter)?(this.keys.clearKeyPressed(Key.Enter),this.fullscreen_group?(this.fullscreen_group.destroy(!0),this.fullscreen_group=null,this.context.pop()):this.closeMap()):this.keys.isKeyPressed(Key.Esc)&&(this.keys.clearKeyPressed(Key.Esc),this.fullscreen_group?(this.fullscreen_group.destroy(!0),this.fullscreen_group=null,this.context.pop()):this.closeMap());break;case InputContext.Instructions:if(this.keys.isKeyPressed(Key.Enter)){if(this.keys.clearKeyPressed(Key.Enter),!this.fullscreen_group)break;(o=this.instruction_nr+1)<=17&&(this.instruction_nr=o,MainMenu.showInstructions(this.fullscreen_group,o))}else if(this.keys.isKeyPressed(Key.Right)){if(this.keys.clearKeyPressed(Key.Right),!this.fullscreen_group)break;var o;(o=this.instruction_nr+1)<=17&&(this.instruction_nr=o,MainMenu.showInstructions(this.fullscreen_group,o))}else if(this.keys.isKeyPressed(Key.Left)){if(this.keys.clearKeyPressed(Key.Left),!this.fullscreen_group)break;var a=this.instruction_nr-1;0<=a&&(this.instruction_nr=a,MainMenu.showInstructions(this.fullscreen_group,a))}else if(this.keys.isKeyPressed(Key.Esc)){if(this.keys.clearKeyPressed(Key.Esc),!this.fullscreen_group)break;this.fullscreen_group.destroy(!0),this.fullscreen_group=null,this.context.pop()}}},t.prototype.openMenu=function(t){t==InputContext.Wait?this.context.push(t):t==InputContext.Shop?this.delegate.hideInfo(!1):this.delegate.hideInfo(!0)},t.prototype.closeMenu=function(t){switch(t==InputContext.Wait&&t==this.context[this.context.length-1]&&this.context.pop(),this.context[this.context.length-1]){case InputContext.Map:case InputContext.Selection:this.delegate.showInfo(!0);break;case InputContext.Shop:this.delegate.showInfo(!1)}},t.prototype.entityDidMove=function(t){var e=this.map.getEntityOptions(t,!0);e.length<1||this.showOptionMenu(e)},t.prototype.entityDidAnimation=function(t){this.context.pop(),this.selected_entity.updateState(EntityState.Moved,!0),this.deselectEntity(!0)},t.prototype.selectEntity=function(t){var e=this.map.getEntityOptions(t,!1);if(e.length<1)return!1;if(this.selected_entity){if(this.selected_entity!=t)return!1}else this.selected_entity=t,this.delegate.selectEntity(t);return 1<e.length?this.showOptionMenu(e):this.selectOption(e[0]),!0},t.prototype.deselectEntity=function(t){this.delegate.deselectEntity(t),this.last_entity_position=null,this.selected_entity=null},t.prototype.showOptionMenu=function(t){this.options_menu=new MenuOptions(this.delegate.frame_manager.group,Direction.Right,t,this),this.delegate.frame_manager.addFrame(this.options_menu),this.options_menu.show(!0),this.context.push(InputContext.Options)},t.prototype.showMainMenu=function(t){this.options_menu=new MenuOptions(this.delegate.frame_manager.group,Direction.None,t,this,Direction.Up),this.delegate.frame_manager.addFrame(this.options_menu),this.options_menu.show(!0),this.context.push(InputContext.Options)},t.prototype.selectOption=function(t){switch(t){case Action.OCCUPY:this.delegate.occupy(this.selected_entity.position,this.selected_entity.alliance),this.selected_entity.updateState(EntityState.Moved,!0),this.deselectEntity(!0);break;case Action.ATTACK:this.context.push(InputContext.Selection),this.delegate.showRange(EntityRangeType.Attack,this.selected_entity),this.delegate.cursor_target=this.map.nextTargetInRange(Direction.None).position.copy(),this.delegate.cursor.hide();break;case Action.RAISE:this.context.push(InputContext.Selection),this.delegate.showRange(EntityRangeType.Raise,this.selected_entity),this.delegate.cursor_target=this.map.nextTargetInRange(Direction.None).position.copy();break;case Action.MOVE:this.delegate.showRange(EntityRangeType.Move,this.selected_entity);break;case Action.BUY:this.openShop(this.selected_entity.alliance);break;case Action.END_MOVE:this.selected_entity.updateState(EntityState.Moved,!0),this.deselectEntity(!0);break;case Action.END_TURN:this.delegate.nextTurn();break;case Action.MAIN_MENU:this.showMainMenu(MenuOptions.getMainMenuOptions(!0));break;case Action.MAP:this.openMap();break;case Action.SAVE_GAME:this.delegate.saveGame();break;case Action.LOAD_GAME:this.delegate.loadGame();break;case Action.EXIT:this.delegate.exitGame();break;case Action.ABOUT:this.context.push(InputContext.Ack),this.fullscreen_group=MainMenu.showAbout(this.delegate.game);break;case Action.INSTRUCTIONS:this.context.push(InputContext.Instructions),this.fullscreen_group=this.delegate.game.add.group(),this.fullscreen_group.fixedToCamera=!0,this.instruction_nr=0,MainMenu.showInstructions(this.fullscreen_group);break;case Action.CANCEL:this.last_entity_position?(this.delegate.cursor_target=this.selected_entity.position.copy(),this.delegate.moveEntity(this.selected_entity,this.last_entity_position,!1),this.last_entity_position=null,this.delegate.showRange(EntityRangeType.Move,this.selected_entity)):this.deselectEntity(!1);break;default:console.log("Action "+MenuOptions.getOptionString(t)+" not yet implemented")}},t.prototype.pickEntity=function(t){switch(this.context.push(InputContext.Animation),this.map.getTypeOfRange()){case EntityRangeType.Attack:this.delegate.attackEntity(this.selected_entity,t);break;case EntityRangeType.Raise:this.delegate.raiseEntity(this.selected_entity,t)}this.delegate.hideRange(),this.delegate.cursor.show()},t.prototype.pickPosition=function(t){if(this.selected_entity)switch(this.map.getTypeOfRange()){case EntityRangeType.Move:this.last_entity_position=this.selected_entity.position.copy(),this.delegate.moveEntity(this.selected_entity,t,!0)}else{var e=this.map.getEntityAt(t);if(e)if(this.selectEntity(e))return;this.showOptionMenu(MenuOptions.getOffMenuOptions())}},t.prototype.openShop=function(t){this.context.push(InputContext.Shop),this.shop_units||(this.shop_units=new MenuShopUnits(this.delegate.frame_manager.group,this),this.delegate.frame_manager.addFrame(this.shop_units)),this.shop_units.updateContent(t,this.delegate.getGoldForAlliance(t)),this.shop_units.show(!0),this.shop_info=new MenuShopInfo(this.delegate.frame_manager.group,t),this.shop_info.updateContent(EntityType.Soldier),this.delegate.frame_manager.addFrame(this.shop_info),this.shop_info.show(!0)},t.prototype.closeShop=function(){this.context.pop(),this.shop_units.hide(!0,!0),this.shop_units=null,this.shop_info.hide(!0,!0),this.shop_info=null},t.prototype.openMap=function(){this.context.push(InputContext.Ack),this.mini_map=new MiniMap(this.map,this.delegate.frame_manager.group,this),this.delegate.frame_manager.addFrame(this.mini_map),this.mini_map.show(!0)},t.prototype.closeMap=function(){this.context.pop(),this.mini_map.hide(!0,!0),this.mini_map=null},t}(Interaction);!function(t){t[t.Path=0]="Path",t[t.Grass=1]="Grass",t[t.Forest=2]="Forest",t[t.Hill=3]="Hill",t[t.Mountain=4]="Mountain",t[t.Water=5]="Water",t[t.Bridge=6]="Bridge",t[t.House=7]="House",t[t.Castle=8]="Castle"}(Tile=Tile||{});var Alliance,Tilemap=function(){function u(t){this.name=t,this.entity_range=new EntityRange(this),this.load()}return u.getTileForCode=function(t){return AncientEmpires.TILES_PROP[t]},u.getCostForTile=function(t,e){if(t==Tile.Water&&e==EntityType.Lizard)return 1;var i=0,i=t==Tile.Mountain||t==Tile.Water?3:t==Tile.Forest||t==Tile.Hill?2:1;return e==EntityType.Lizard?2*i:i},u.getDefForTile=function(t,e){return t==Tile.Mountain||t==Tile.House||t==Tile.Castle?3:t==Tile.Forest||t==Tile.Hill||t==Tile.Water&&void 0!==e&&e==EntityType.Lizard?2:t==Tile.Grass?1:0},u.prototype.load=function(){if(!AncientEmpires.game.cache.checkBinaryKey(this.name))return console.log("Could not find map: "+this.name),!1;this.buildings=[],this.entities=[],this.tiles=[];var t=AncientEmpires.game.cache.getBinary(this.name),e=new DataView(t),i=0;this.width=e.getUint32(i),i+=4,this.height=e.getUint32(i),i+=4;for(var s=0;s<this.width;s++){this.tiles[s]=[];for(var n=0;n<this.height;n++){var o=e.getUint8(i++),a=u.getTileForCode(o);(this.tiles[s][n]=a)!=Tile.House&&a!=Tile.Castle||this.buildings.push({castle:a==Tile.Castle,position:new Pos(s,n),alliance:Math.floor((o-AncientEmpires.NUMBER_OF_TILES)/3)})}}i+=4+4*e.getUint32(i);var r=e.getUint32(i);i+=4;for(var h=0;h<r;h++){var c=e.getUint8(i++),p=c%11,l=Math.floor(c/11)+1,s=Math.floor(e.getUint16(i)/16);i+=2;n=Math.floor(e.getUint16(i)/16);i+=2,this.entities.push(new Entity(p,l,new Pos(s,n)))}},u.prototype.importEntities=function(t){this.entities=[];for(var e=0,i=t;e<i.length;e++){var s=i[e],n=this.createEntity(s.type,s.alliance,new Pos(s.x,s.y));n.health=s.health,n.state=s.state,n.status=s.status,n.ep=s.ep,n.rank=s.rank,n.death_count=s.death_count}},u.prototype.importBuildings=function(t){for(var e=0,i=t;e<i.length;e++){var s=i[e],n=this.getBuildingAt(new Pos(s.x,s.y));n&&(n.alliance=s.alliance)}},u.prototype.exportEntities=function(){for(var t=[],e=0,i=this.entities;e<i.length;e++){var s=i[e];t.push(s.export())}return t},u.prototype.exportBuildings=function(){for(var t=[],e=0,i=this.buildings;e<i.length;e++){var s=i[e];s.alliance!=Alliance.None&&t.push({x:s.position.x,y:s.position.y,alliance:s.alliance})}return t},u.prototype.createEntity=function(t,e,i){var s=new Entity(t,e,i);return this.entities.push(s),s},u.prototype.removeEntity=function(t){for(var e=0;e<this.entities.length;e++)if(t==this.entities[e]){this.entities.splice(e,1);break}t.destroy()},u.prototype.getEntityAt=function(t){for(var e=0,i=this.entities;e<i.length;e++){var s=i[e];if(s.position.match(t)&&!s.isDead())return s}return null},u.prototype.getKingPosition=function(t){for(var e=0,i=this.entities;e<i.length;e++){var s=i[e];if(s.alliance==t&&s.type==EntityType.King)return s.position.copy()}return null},u.prototype.getEntitiesWith=function(t,e,i){for(var s=[],n=0,o=this.entities;n<o.length;n++){var a=o[n];a.alliance==t&&(void 0!==i&&a.type!=i||void 0!==e&&a.state!=e||void 0===e&&a.state==EntityState.Dead||s.push(a))}return s},u.prototype.countEntitiesWith=function(t,e,i){return this.getEntitiesWith(t,e,i).length},u.prototype.nextTurn=function(t){for(var e=this.entities.length-1;0<=e;e--){var i,s,n=this.entities[e];n.isDead()?(n.death_count++,n.death_count>=AncientEmpires.DEATH_COUNT&&this.removeEntity(n)):(n.alliance==t?(n.state=EntityState.Ready,this.getAllianceAt(n.position)==n.alliance&&(i=Math.min(n.health+2,10),n.setHealth(i))):(n.state=EntityState.Moved,n.clearStatus(EntityStatus.Poisoned)),s=n.alliance==t,n.updateState(n.state,s))}},u.prototype.getTileAt=function(t){return this.tiles[t.x][t.y]},u.prototype.getAdjacentTilesAt=function(t){return[0<t.y?this.getTileAt(new Pos(t.x,t.y-1)):-1,t.x<this.width-1?this.getTileAt(new Pos(t.x+1,t.y)):-1,t.y<this.height-1?this.getTileAt(new Pos(t.x,t.y+1)):-1,0<t.x?this.getTileAt(new Pos(t.x-1,t.y)):-1]},u.prototype.getAdjacentPositionsAt=function(t){var e=[];return 0<t.y&&e.push(new Pos(t.x,t.y-1)),t.x<this.width-1&&e.push(new Pos(t.x+1,t.y)),t.y<this.height-1&&e.push(new Pos(t.x,t.y+1)),0<t.x&&e.push(new Pos(t.x-1,t.y)),e},u.prototype.setAllianceAt=function(t,e){for(var i=0,s=this.buildings;i<s.length;i++){var n=s[i];if(n.position.match(t))return n.alliance=e,!0}return!1},u.prototype.getBuildingAt=function(t){for(var e=0,i=this.buildings;e<i.length;e++){var s=i[e];if(s.position.match(t))return s}return null},u.prototype.getAllianceAt=function(t){var e=this.getBuildingAt(t);return e?e.alliance:Alliance.None},u.prototype.getOccupiedHouses=function(){for(var t=[],e=0,i=this.buildings;e<i.length;e++){var s=i[e];s.castle||s.alliance==Alliance.None||t.push(s)}return t},u.prototype.getNearestHouseForEntity=function(t){for(var e=-1,i=null,s=0,n=this.buildings;s<n.length;s++){var o,a=n[s];a.castle||(o=Math.abs(a.position.x-t.position.x)+Math.abs(a.position.y-t.position.y),0<=e&&e<=o||(2==this.getMap()||t.type==EntityType.Soldier&&a.alliance!=t.alliance||t.type!=EntityType.Soldier&&a.alliance==t.alliance)&&(e=o,i=a))}return i},u.prototype.getGoldGainForAlliance=function(t){for(var e=0,i=0,s=this.buildings;i<s.length;i++){var n=s[i];n.alliance==t&&(e+=n.castle?50:30)}return e},u.prototype.getCostAt=function(t,e){return u.getCostForTile(this.getTileAt(t),e)},u.prototype.getDefAt=function(t,e){return u.getDefForTile(this.getTileAt(t),e)},u.prototype.isCampaign=function(){return"m"==this.name.charAt(0)},u.prototype.getMap=function(){return parseInt(this.name.charAt(1),10)},u.prototype.getEntityOptions=function(t,e){if(void 0===e&&(e=!1),t.state!=EntityState.Ready)return[];if(this.getEntityAt(t.position)!=t)return[Action.MOVE];var i=[];return!e&&t.hasFlag(EntityFlags.CanBuy)&&this.getTileAt(t.position)==Tile.Castle&&i.push(Action.BUY),t.hasFlag(EntityFlags.CantAttackAfterMoving)&&e||0<this.getAttackTargets(t).length&&i.push(Action.ATTACK),t.hasFlag(EntityFlags.CanRaise)&&0<this.getRaiseTargets(t).length&&i.push(Action.RAISE),this.getAllianceAt(t.position)!=t.alliance&&(t.hasFlag(EntityFlags.CanOccupyHouse)&&this.getTileAt(t.position)==Tile.House||t.hasFlag(EntityFlags.CanOccupyCastle)&&this.getTileAt(t.position)==Tile.Castle)&&i.push(Action.OCCUPY),e?i.push(Action.END_MOVE):i.push(Action.MOVE),i},u.prototype.getAttackTargets=function(t,e){for(var i=[],s=0,n=this.entities;s<n.length;s++){var o,a=n[s];a.alliance!=t.alliance&&(a.isDead()||(o=t.getDistanceToEntity(a),void 0!==e&&(o=e.distanceTo(a.position)),o>t.data.max||o<t.data.min||i.push(a)))}return i},u.prototype.getRaiseTargets=function(t,e){for(var i=[],s=0,n=this.entities;s<n.length;s++){var o,a=n[s];a.isDead()&&(o=t.getDistanceToEntity(a),void 0!==e&&(o=e.distanceTo(a.position)),1==o&&i.push(a))}return i},u.prototype.resetWisp=function(t){for(var e=0,i=this.entities;e<i.length;e++){var s=i[e];s.alliance==t&&(s.clearStatus(EntityStatus.Wisped),this.hasWispInRange(s)&&s.setStatus(EntityStatus.Wisped))}},u.prototype.hasWispInRange=function(t){for(var e=0,i=this.entities;e<i.length;e++){var s=i[e];if(s.alliance==t.alliance&&(s.hasFlag(EntityFlags.CanWisp)&&!s.isDead())){var n=t.getDistanceToEntity(s);if(!(n<1||2<n))return!0}}return!1},u.prototype.showRange=function(t,e){var i=null;return t!=EntityRangeType.Attack&&t!=EntityRangeType.Raise||(t==EntityRangeType.Attack?i=this.getAttackTargets(e):t==EntityRangeType.Raise&&(i=this.getRaiseTargets(e))),this.entity_range.createRange(t,e,i),this.entity_range},u.prototype.moveEntity=function(t,e,i,s){if(void 0===s&&(s=!0),!s)return t.position=e,t.setWorldPosition(e.getWorldPosition()),!0;if(this.getEntityAt(e)&&!e.match(t.position))return!1;var n=this.entity_range.getWaypointAt(e);if(!n)return!1;var o=EntityRange.getLineToWaypoint(n);return t.move(e,o,i),!0},u.prototype.nextTargetInRange=function(t){return this.entity_range.nextTargetInRange(t)},u.prototype.selectTargetInRange=function(t){return this.entity_range.selectTarget(t)},u.prototype.getTypeOfRange=function(){return this.entity_range.type},u}();!function(t){t[t.None=0]="None",t[t.Blue=1]="Blue",t[t.Red=2]="Red"}(Alliance=Alliance||{});var Action,TileManager=function(){function n(t,e,i){this.waterState=0,this.waterTimer=0,this.map=t,this.tilemap=e,this.group=i,this.tilemap.addTilesetImage("tiles0",null,AncientEmpires.TILE_SIZE,AncientEmpires.TILE_SIZE,null,null,0),this.tilemap.addTilesetImage("buildings_0",null,AncientEmpires.TILE_SIZE,AncientEmpires.TILE_SIZE,null,null,AncientEmpires.NUMBER_OF_TILES),this.tilemap.addTilesetImage("buildings_1",null,AncientEmpires.TILE_SIZE,AncientEmpires.TILE_SIZE,null,null,AncientEmpires.NUMBER_OF_TILES+3),this.tilemap.addTilesetImage("buildings_2",null,AncientEmpires.TILE_SIZE,AncientEmpires.TILE_SIZE,null,null,AncientEmpires.NUMBER_OF_TILES+6),this.backgroundLayer=this.tilemap.create("background",this.map.width,this.map.height,AncientEmpires.TILE_SIZE,AncientEmpires.TILE_SIZE,this.group),this.backgroundLayer.resizeWorld(),this.buildingLayer=this.tilemap.createBlankLayer("building",this.map.width,this.map.height,AncientEmpires.TILE_SIZE,AncientEmpires.TILE_SIZE,this.group)}return n.doesTileCutGrass=function(t){return t==Tile.Path||t==Tile.Water||t==Tile.Bridge},n.getImageIndexForObjectTile=function(t){return t==Tile.Mountain?0:t==Tile.Forest?1:t==Tile.Hill?2:t==Tile.House?AncientEmpires.NUMBER_OF_TILES:t==Tile.Castle?AncientEmpires.NUMBER_OF_TILES+1:-1},n.getBaseImageIndexForTile=function(t){switch(t){case Tile.Water:return 21;case Tile.Bridge:return 19;case Tile.Path:return 18;case Tile.Hill:case Tile.Forest:case Tile.Mountain:case Tile.House:case Tile.Castle:return n.getImageIndexForObjectTile(t)}return 3},n.prototype.draw=function(){for(var t=0;t<this.map.width;t++)for(var e=0;e<this.map.height;e++)this.drawTileAt(new Pos(t,e))},n.prototype.update=function(t){this.waterTimer+=t,30<this.waterTimer&&(this.waterTimer=0,this.updateWater())},n.prototype.updateWater=function(){var t=this.waterState;this.waterState=1-this.waterState,this.tilemap.replace(21+t,21+this.waterState,0,0,this.map.width,this.map.height,this.backgroundLayer)},n.prototype.drawTileAt=function(t){this.tilemap.putTile(this.getImageIndexForBackgroundAt(t),t.x,t.y,this.backgroundLayer);var e=this.map.getTileAt(t),i=n.getImageIndexForObjectTile(e);0<=i&&(e!=Tile.House&&e!=Tile.Castle||(i+=3*this.map.getAllianceAt(t),e==Tile.Castle&&0<t.y&&this.tilemap.putTile(i+1,t.x,t.y-1,this.buildingLayer)),this.tilemap.putTile(i,t.x,t.y,this.buildingLayer))},n.prototype.getImageIndexForBackgroundAt=function(t){switch(this.map.getTileAt(t)){case Tile.Water:return 21;case Tile.Bridge:var e=this.map.getAdjacentTilesAt(t);return e[0]!=Tile.Water||e[2]!=Tile.Water?20:19;case Tile.Path:return 18;case Tile.Grass:case Tile.Hill:case Tile.Forest:case Tile.Mountain:case Tile.House:case Tile.Castle:return this.getImageIndexForGrassAt(t)}return 2},n.prototype.getImageIndexForGrassAt=function(t){for(var e=this.map.getAdjacentTilesAt(t),i=0,s=0;s<e.length;s++)i+=Math.pow(2,s)*(n.doesTileCutGrass(e[s])?1:0);return 15==i?3:13==i?16:14==i?10:7==i?17:11==i?14:9==i?12:12==i?8:6==i?9:3==i?13:5==i?15:10==i?6:8==i?4:4==i?7:2==i?5:1==i?11:3},n}(),Smoke=function(o){function t(t,e,i,s){var n=o.call(this)||this;return n.position=t,o.prototype.init.call(n,new Pos(t.x*AncientEmpires.TILE_SIZE+16,t.y*AncientEmpires.TILE_SIZE),e,i,s),n}return __extends(t,o),t}(Sprite),SmokeManager=function(){function t(t,e){this.map=t,this.group=e,this.anim_slow=0,this.anim_state=0,this.anim_offset=0,this.smoke=[];for(var i=0,s=t.getOccupiedHouses();i<s.length;i++){var n=s[i];this.createSmoke(n.position)}this.createSmoke(new Pos(3,13))}return t.prototype.createSmoke=function(t){this.smoke.push(new Smoke(t,this.group,"b_smoke",[0,1,2,3]))},t.prototype.update=function(t){if(this.anim_slow+=t,!(this.anim_slow<5)){this.anim_slow=0,this.anim_offset++,27<this.anim_offset?(this.anim_state=0,this.anim_offset=0,this.group.visible=!0):22<this.anim_offset&&3==this.anim_state?(this.anim_state=4,this.group.visible=!1):17<this.anim_offset&&2==this.anim_state?this.anim_state=3:12<this.anim_offset&&1==this.anim_state?this.anim_state=2:7<this.anim_offset&&0==this.anim_state&&(this.anim_state=1);for(var e=0,i=this.smoke;e<i.length;e++){var s=i[e];s.setFrame(this.anim_state),s.world_position.y=s.position.y*AncientEmpires.TILE_SIZE-this.anim_offset-2,s.update()}}},t}(),MenuGoldInfo=function(i){function t(t){var e=i.call(this)||this;return e.initialize(64,40,t,Direction.Up|Direction.Right,Direction.Down|Direction.Left,Direction.Right),e.drawContent(),e}return __extends(t,i),t.prototype.updateContent=function(t,e){var i,s,n=t==Alliance.Blue?(i=255,s=0):(i=16711680,s=1,25);this.head_graphics.clear(),this.head_graphics.beginFill(i),this.head_graphics.drawRect(0,17,this.width-6,17),this.head_graphics.endFill(),this.head_icon.frame=s,this.head_icon.x=n,this.gold_amount.setText(e.toString())},t.prototype.drawContent=function(){this.head_graphics=this.group.game.add.graphics(0,0,this.content_group),this.group.game.add.image(2,2,"gold",null,this.content_group),this.head_icon=this.group.game.add.image(0,16,"portrait",0,this.content_group);var t=new Phaser.Rectangle(0,10,this.head_icon.width,18);this.head_icon.crop(t),this.gold_amount=new AEFont(28,5,this.content_group,AEFontStyle.Bold)},t}(Frame),MenuDefInfo=function(i){function t(t){var e=i.call(this)||this;return e.initialize(40,52,t,Direction.Down|Direction.Right,Direction.Up|Direction.Left,Direction.Right),e.drawContent(),e}return __extends(t,i),t.prototype.updateContent=function(t,e){var i,s=e.getTileAt(t),n=e.getEntityAt(t);s==Tile.House||s==Tile.Castle?(i=e.getAllianceAt(t),this.tile_icon.key!="buildings_"+i&&this.tile_icon.loadTexture("buildings_"+i),this.tile_icon.frame=s==Tile.House?0:1):("tiles0"!=this.tile_icon.key&&this.tile_icon.loadTexture("tiles0"),this.tile_icon.frame=TileManager.getBaseImageIndexForTile(s)),this.def_amount.setText(Tilemap.getDefForTile(s,n?n.type:void 0).toString()),n?(this.updateSize(68,52),this.entity_icon.key!="unit_icons_"+n.alliance&&this.entity_icon.loadTexture("unit_icons_"+n.alliance),this.entity_icon.frame=n.type,this.entity_icon.visible=!0):(this.updateSize(40,52),this.entity_icon.visible=!1),this.setStatusIcons(n)},t.prototype.drawContent=function(){var t=this.group.game.add.graphics(0,0,this.content_group);t.lineStyle(1,0),t.drawRect(6,2,AncientEmpires.TILE_SIZE-1,AncientEmpires.TILE_SIZE-1),this.tile_icon=this.group.game.add.image(7,3,"tiles0",null,this.content_group);var e=new Phaser.Rectangle(1,1,AncientEmpires.TILE_SIZE-2,AncientEmpires.TILE_SIZE-2);this.tile_icon.crop(e),new AEFont(7,28,this.content_group,AEFontStyle.Bold).setText("DEF"),this.def_amount=new AEFont(14,37,this.content_group,AEFontStyle.Bold),this.entity_icon=this.group.game.add.image(35,2,"unit_icons_1",null,this.content_group),this.entity_icon.visible=!1,this.status_icons=[this.group.game.add.image(31,22,"status",2,this.content_group),this.group.game.add.image(39,22,"status",2,this.content_group),this.group.game.add.image(47,22,"status",2,this.content_group),this.group.game.add.image(31,32,"status",0,this.content_group),this.group.game.add.image(46,32,"status",1,this.content_group)],this.setStatusIcons(null)},t.prototype.setStatusIcons=function(t){this.status_icons[0].visible=!!(t&&0<t.rank),this.status_icons[1].visible=!!(t&&1<t.rank),this.status_icons[2].visible=!!(t&&2<t.rank),this.status_icons[3].visible=!(!t||t.status==EntityStatus.None),this.status_icons[3].frame=t&&0!=(t.status&EntityStatus.Poisoned)?0:1,this.status_icons[4].visible=!(!t||t.status!=(EntityStatus.Wisped|EntityStatus.Poisoned))},t}(Frame);!function(t){t[t.None=0]="None",t[t.MAIN_MENU=1]="MAIN_MENU",t[t.MOVE=2]="MOVE",t[t.ATTACK=3]="ATTACK",t[t.BUY=4]="BUY",t[t.END_MOVE=5]="END_MOVE",t[t.CANCEL=6]="CANCEL",t[t.END_TURN=7]="END_TURN",t[t.OCCUPY=8]="OCCUPY",t[t.RAISE=9]="RAISE",t[t.MAP=10]="MAP",t[t.OBJECTIVE=11]="OBJECTIVE",t[t.NEW_GAME=12]="NEW_GAME",t[t.SELECT_LEVEL=13]="SELECT_LEVEL",t[t.SAVE_GAME=14]="SAVE_GAME",t[t.LOAD_GAME=15]="LOAD_GAME",t[t.SKIRMISH=16]="SKIRMISH",t[t.SETTINGS=17]="SETTINGS",t[t.INSTRUCTIONS=18]="INSTRUCTIONS",t[t.ABOUT=19]="ABOUT",t[t.EXIT=20]="EXIT"}(Action=Action||{});var InputContext,MenuOptions=function(g){function d(t,e,i,s,n){var o=g.call(this)||this;n=n||e,o.menu_delegate=s,o.options=i;for(var a=o.selected=0,r=0,h=o.options;r<h.length;r++){var c=h[r],p=d.getOptionString(c);p.length>a&&(a=p.length)}var l=13*o.options.length+16,u=7*a+31+13;return o.initialize(u,l,t,e,Direction.All&~e,n),o.drawContent(),o}return __extends(d,g),d.getMainMenuOptions=function(t){var e=t?[Action.SAVE_GAME,Action.LOAD_GAME,Action.INSTRUCTIONS,Action.ABOUT,Action.EXIT]:[Action.NEW_GAME,Action.LOAD_GAME,Action.SKIRMISH,Action.INSTRUCTIONS,Action.ABOUT,Action.EXIT];return e},d.getOffMenuOptions=function(){return[Action.END_TURN,Action.MAP,Action.OBJECTIVE,Action.MAIN_MENU]},d.getOptionString=function(t){return t==Action.None?"":12<=t?AncientEmpires.LANG[t-12+1]:AncientEmpires.LANG[26+t]},d.prototype.drawContent=function(){var t=5;this.fonts=[];for(var e=0,i=this.options;e<i.length;e++){var s=i[e],n=d.getOptionString(s),o=this.group.game.add.bitmapText(25,t,"font7",n,7,this.content_group);this.fonts.push(o),t+=13}this.pointer=this.group.game.add.image(4,4,"pointer",null,this.content_group),this.pointer_state=2,this.pointer_slow=0},d.prototype.hide=function(t,e,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=!1),this.menu_delegate&&this.menu_delegate.closeMenu(InputContext.Options),g.prototype.hide.call(this,t,e,i)},d.prototype.show=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=0),this.menu_delegate&&this.menu_delegate.openMenu(InputContext.Options),g.prototype.show.call(this,t,e)},d.prototype.next=function(){this.selected++,this.selected>=this.options.length&&(this.selected=0)},d.prototype.prev=function(){this.selected--,this.selected<0&&(this.selected=this.options.length-1)},d.prototype.getSelected=function(){return this.options[this.selected]},d.prototype.update=function(t){g.prototype.update.call(this,t),this.pointer_slow++,10<this.pointer_slow&&(this.pointer_slow=0,this.pointer_state=2-this.pointer_state),this.pointer.y=4+13*this.selected,this.pointer.x=4+this.pointer_state},d}(Frame),MenuSelect=function(u){function t(t,e,i,s,n){var o=u.call(this)||this;o.menu_delegate=i,o.options=t;for(var a=o.selected=0,r=0,h=o.options;r<h.length;r++){var c=h[r];c.length>a&&(a=c.length)}var p=13*o.options.length+16,l=7*a+31+13;return o.initialize(l,p,e,s,Direction.All&~s,n),o.drawContent(),o}return __extends(t,u),t.prototype.drawContent=function(){var t=5;this.fonts=[];for(var e=0,i=this.options;e<i.length;e++){var s=i[e],n=this.group.game.add.bitmapText(25,t,"font7",s,7,this.content_group);this.fonts.push(n),t+=13}this.pointer=this.group.game.add.image(4,4,"pointer",null,this.content_group),this.pointer_state=2,this.pointer_slow=0},t.prototype.hide=function(t,e,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=!1),this.menu_delegate&&this.menu_delegate.closeMenu(InputContext.Options),u.prototype.hide.call(this,t,e,i)},t.prototype.show=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=0),this.menu_delegate&&this.menu_delegate.openMenu(InputContext.Options),u.prototype.show.call(this,t,e)},t.prototype.next=function(){this.selected++,this.selected>=this.options.length&&(this.selected=0)},t.prototype.prev=function(){this.selected--,this.selected<0&&(this.selected=this.options.length-1)},t.prototype.getSelected=function(){return this.options[this.selected]},t.prototype.update=function(t){u.prototype.update.call(this,t),this.pointer_slow++,10<this.pointer_slow&&(this.pointer_slow=0,this.pointer_state=2-this.pointer_state),this.pointer.y=4+13*this.selected,this.pointer.x=4+this.pointer_state},t}(Frame),NotificationFrame=function(o){function t(t,e,i){var s=o.call(this)||this;s.menu_delegate=i,s.font=t.game.add.bitmapText(9,5,"font7",e,7),s.font.updateTransform();var n=s.font.textWidth+30;return s.initialize(n,29,t,Direction.None,Direction.All,Direction.None),s.content_group.add(s.font),s}return __extends(t,o),t.prototype.show=function(t){void 0===t&&(t=!1),this.menu_delegate&&this.menu_delegate.openMenu(InputContext.Wait),o.prototype.show.call(this,t)},t.prototype.animationDidEnd=function(t){var e=this;0!=(t&FrameAnimation.Show)?setTimeout(function(){e.hide(!0,!0)},1e3):0!=(t&FrameAnimation.Destroy)&&this.menu_delegate&&this.menu_delegate.closeMenu(InputContext.Wait)},t}(Frame),MenuShopUnits=function(s){function t(t,e){var i=s.call(this)||this;return i.selected=0,i.menu_delegate=e,i.initialize(64,t.game.height-40,t,Direction.Right|Direction.Down,Direction.Up|Direction.Down|Direction.Left,Direction.Right),i.drawContent(),i}return __extends(t,s),t.prototype.updateContent=function(t,e){for(var i=0,s=0,n=this.entity_images;s<n.length;s++){var o=n[s],a=AncientEmpires.ENTITIES[i].cost;o.loadTexture("unit_icons_"+t,o.frame),this.masks[i].visible=e<a,i++}},t.prototype.getSelected=function(){return this.selected},t.prototype.show=function(t){void 0===t&&(t=!1),this.menu_delegate&&this.menu_delegate.openMenu(InputContext.Shop),s.prototype.show.call(this,t)},t.prototype.hide=function(t,e,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=!1),this.menu_delegate&&this.menu_delegate.closeMenu(InputContext.Shop),s.prototype.hide.call(this,t,e,i)},t.prototype.update=function(t){s.prototype.update.call(this,t),this.pointer_slow++,10<this.pointer_slow&&(this.pointer_slow=0,this.pointer_state=2-this.pointer_state),this.pointer.y=5+29*Math.floor(this.selected/2),this.pointer.x=this.selected%2*28-9+this.pointer_state},t.prototype.prev=function(t){t?this.selected-=2:this.selected--,this.selected<0&&(this.selected+=this.entity_images.length)},t.prototype.next=function(t){t?this.selected+=2:this.selected++,this.selected>=this.entity_images.length&&(this.selected-=this.entity_images.length)},t.prototype.drawContent=function(){this.entity_images=[],this.masks=[];for(var t,e,i,s,n=0;n<AncientEmpires.ENTITIES.length;n++){1e3<AncientEmpires.ENTITIES[n].cost||(t=n%2*27+3,e=29*Math.floor(n/2)+5,i=this.group.game.add.image(t,e,"unit_icons_1",n,this.content_group),this.entity_images.push(i),s=this.group.game.add.image(t,e,"mask",0,this.content_group),this.masks.push(s))}this.pointer=this.group.game.add.image(4,4,"pointer",null,this.content_group),this.pointer_state=2,this.pointer_slow=0},t}(Frame),MenuShopInfo=function(s){function t(t,e){var i=s.call(this)||this;return i.initialize(t.game.width-64,t.game.height,t,Direction.Left,Direction.Up|Direction.Right|Direction.Down,Direction.Left),i.drawContent(e),i}return __extends(t,s),t.prototype.updateContent=function(t){var e=AncientEmpires.ENTITIES[t];this.unit_icon.frame=t,this.unit_name.setText(e.name.toUpperCase()),this.unit_cost.setText(e.cost.toString()),this.unit_atk.setText(e.atk.toString()),this.unit_def.setText(e.def.toString()),this.unit_mov.setText(e.mov.toString()),this.unit_text.setText(AncientEmpires.LANG[75+t])},t.prototype.drawContent=function(t){this.unit_icon=this.group.game.add.image(2,2,"unit_icons_"+(t==Alliance.Blue?1:2),0,this.content_group),this.unit_name=this.group.game.add.bitmapText(29,4,"font7","",7,this.content_group),this.group.game.add.image(28,13,"gold",0,this.content_group),this.unit_cost=new AEFont(54,16,this.content_group,AEFontStyle.Bold,""),new AEFont(2,33,this.content_group,AEFontStyle.Bold,"ATK"),this.unit_atk=new AEFont(95,33,this.content_group,AEFontStyle.Bold,""),new AEFont(2,43,this.content_group,AEFontStyle.Bold,"DEF"),this.unit_def=new AEFont(95,43,this.content_group,AEFontStyle.Bold,""),new AEFont(2,53,this.content_group,AEFontStyle.Bold,"MOV"),this.unit_mov=new AEFont(95,53,this.content_group,AEFontStyle.Bold,""),this.unit_text=this.group.game.add.bitmapText(6,69,"font7","",7,this.content_group),this.unit_text.maxWidth=this.group.game.width-64-18},t}(Frame);!function(t){t[t.Wait=0]="Wait",t[t.Shop=1]="Shop",t[t.Options=2]="Options",t[t.Map=3]="Map",t[t.Selection=4]="Selection",t[t.Animation=5]="Animation",t[t.Ack=6]="Ack",t[t.Instructions=7]="Instructions"}(InputContext=InputContext||{});var Direction,ActiveMenuType,GameController=function(e){function t(){var t=e.call(this)||this;return t.acc=0,t}return __extends(t,e),t.prototype.init=function(e){var t;this.map=new Tilemap((e.campaign?"m":"s")+e.map),this.players=[],this.game_over=!1;for(var i=Alliance.Blue,s=0,n=e.players;s<n.length;s++){n[s]?(t=t||new Input(this.game.input),this.players.push(new Player(i,this.map,this,t))):this.players.push(new AI(i,this.map,this)),i+=1}try{this.turn=e.turn,this.gold=e.gold,this.map.importBuildings(e.buildings),this.map.importEntities(e.entities);for(var o=0,a=0,r=e.cursors;a<r.length;a++){var h=r[a];h&&(this.players[o].cursor_position=new Pos(h.x,h.y)),o++}}catch(t){this.turn=Alliance.Blue,this.gold=[],e.campaign?(this.gold[0]=300,this.gold[1]=300):(this.gold[0]=1e3,this.gold[1]=1e3)}},t.prototype.create=function(){var t=this.game.add.tilemap(),e=this.game.add.group(),i=this.game.add.group(),s=this.game.add.group(),n=this.game.add.group(),o=this.game.add.group(),a=this.game.add.group(),r=this.game.add.group(),h=this.game.add.group();h.fixedToCamera=!0,this.tile_manager=new TileManager(this.map,t,e),this.entity_manager=new EntityManager(this.map,n,s,o,r,this),this.smoke_manager=new SmokeManager(this.map,i),this.frame_manager=new FrameManager(h),this.tile_manager.draw(),this.frame_def_info=new MenuDefInfo(h),this.frame_manager.addFrame(this.frame_def_info),this.frame_def_info.show(!0),this.frame_gold_info=new MenuGoldInfo(h),this.frame_manager.addFrame(this.frame_gold_info),this.frame_gold_info.show(!0),this.cursor=new Sprite,this.cursor.init({x:0,y:0},a,"cursor",[0,1]),this.cursor.setOffset(-1,-1),this.camera.x=this.getOffsetX(this.cursor.world_position.x),this.camera.y=this.getOffsetY(this.cursor.world_position.y),this.anim_cursor_state=0,this.anim_cursor_slow=0,this.startTurn(this.turn),this.showMessage("GAME LOADED")},t.prototype.update=function(){this.acc+=this.time.elapsed;var t,e,i,s,n,o,a=Math.floor(this.acc/16);a<=0||(this.acc-=16*a,2<a&&(a=2),e=(t=this.cursor_target.getWorldPosition()).x-this.cursor.world_position.x,i=t.y-this.cursor.world_position.y,n=s=0,this.cursor_still=0==e&&0==i,0!=e&&(s=(s=Math.floor(e/4))<0?(s=Math.max(s,-4),Math.min(s,-1)):(s=Math.min(s,4),Math.max(s,1)),this.cursor.setWorldPosition({x:this.cursor.world_position.x+s,y:this.cursor.world_position.y+n})),0!=i&&(n=(n=Math.floor(i/4))<0?(n=Math.max(n,-4),Math.min(n,-1)):(n=Math.min(n,4),Math.max(n,1)),this.cursor.setWorldPosition({x:this.cursor.world_position.x+s,y:this.cursor.world_position.y+n})),this.updateOffsetForPosition(this.selected_entity&&this.selected_entity.path?this.selected_entity.world_position:this.cursor.world_position),this.checkWinLose(),this.game_over||(this.players[this.turn-1].run(),this.players[this.turn-1].setCursorPosition(this.cursor_target)),this.cursor_target.match(this.last_cursor_position)||(this.last_cursor_position=this.cursor_target.copy(),this.frame_def_info.updateContent(this.cursor_target,this.map)),this.frame_manager.update(a),this.anim_cursor_slow+=a,30<this.anim_cursor_slow&&(this.anim_cursor_slow-=30,this.anim_cursor_state=1-this.anim_cursor_state,this.cursor.setFrame(this.anim_cursor_state)),this.tile_manager.update(a),this.smoke_manager.update(a),this.entity_manager.update(a,this.cursor_target,this.anim_cursor_state),!(o=0!=(this.frame_gold_info.align&Direction.Right))&&this.cursor.world_position.x-1-this.camera.x<=this.game.width/2-24-12?(this.frame_gold_info.updateDirections(Direction.Up|Direction.Right,Direction.Left|Direction.Down,Direction.Right,!0),this.frame_def_info.updateDirections(Direction.Down|Direction.Right,Direction.Left|Direction.Up,Direction.Right,!0)):o&&this.cursor.world_position.x+1-this.camera.x>=this.game.width/2+12&&(this.frame_gold_info.updateDirections(Direction.Up|Direction.Left,Direction.Right|Direction.Down,Direction.Left,!0),this.frame_def_info.updateDirections(Direction.Down|Direction.Left,Direction.Right|Direction.Up,Direction.Left,!0)))},t.prototype.openMenu=function(t){this.players[this.turn-1].openMenu(t)},t.prototype.closeMenu=function(t){for(var e=0,i=this.players;e<i.length;e++){i[e].closeMenu(t)}},t.prototype.entityDidMove=function(t){this.players[this.turn-1].entityDidMove(t)},t.prototype.entityDidAnimation=function(t){this.players[this.turn-1].entityDidAnimation(t)},t.prototype.showMessage=function(t){var e=new NotificationFrame(this.frame_manager.group,t,this);this.frame_manager.addFrame(e),e.show(!0)},t.prototype.showInfo=function(t){this.frame_def_info.show(!0),t&&this.frame_gold_info.show(!0)},t.prototype.hideInfo=function(t){this.frame_def_info.hide(!0),t&&this.frame_gold_info.hide(!0)},t.prototype.loadGame=function(){return!!MainMenu.loadGame(this.game)||(this.showMessage(AncientEmpires.LANG[43]),!1)},t.prototype.saveGame=function(){for(var t=[],e=[],i=0,s=this.players;i<s.length;i++){var n=s[i];t.push(n.getCursorPosition()),e.push(n.isPlayer())}var o={campaign:this.map.isCampaign(),map:this.map.getMap(),turn:this.turn,gold:this.gold,players:e,entities:this.map.exportEntities(),buildings:this.map.exportBuildings(),cursors:t};localStorage.setItem("save.rs",JSON.stringify(o)),this.showMessage(AncientEmpires.LANG[41])},t.prototype.exitGame=function(){this.game.state.start("MainMenu",!0,!1)},t.prototype.checkWinLose=function(){this.game_over||(0<this.map.countEntitiesWith(Alliance.Blue,EntityState.Dead,EntityType.King)?(this.showMessage(AncientEmpires.LANG[38]),this.game_over=!0):0<this.map.countEntitiesWith(Alliance.Red,EntityState.Dead,EntityType.King)&&(this.showMessage(AncientEmpires.LANG[24]),this.game_over=!0))},t.prototype.nextTurn=function(){this.showMessage(AncientEmpires.LANG[40]);var t=Alliance.Blue;this.turn==Alliance.Blue&&(t=Alliance.Red),this.players[t-1].isActive()||(t=this.turn),this.gold[t==Alliance.Blue?0:1]+=this.map.getGoldGainForAlliance(t),this.map.nextTurn(t),this.startTurn(t)},t.prototype.getGoldForAlliance=function(t){switch(t){case Alliance.Blue:return this.gold[0];case Alliance.Red:return this.gold[1]}return-1},t.prototype.setGoldForAlliance=function(t,e){var i;switch(t){case Alliance.Blue:i=0;break;case Alliance.Red:i=1}this.gold[i]=e,this.turn==t&&this.frame_gold_info.updateContent(t,e)},t.prototype.buyEntity=function(t,e){var i=AncientEmpires.ENTITIES[e],s=this.getGoldForAlliance(t.alliance)-i.cost;if(s<0)return null;this.setGoldForAlliance(t.alliance,s);var n=this.map.createEntity(e,t.alliance,t.position.copy());return this.entity_manager.createEntity(n),n},t.prototype.selectEntity=function(t){return!this.selected_entity&&(this.selected_entity=t,this.entity_manager.selectEntity(t),!0)},t.prototype.moveEntity=function(t,e,i){return!!this.map.moveEntity(t,e,this,i)&&(this.hideRange(),!0)},t.prototype.occupy=function(t,e){this.map.setAllianceAt(t,e),this.tile_manager.drawTileAt(t),this.showMessage(AncientEmpires.LANG[39])},t.prototype.showRange=function(t,e){return this.map.showRange(t,e),this.entity_manager.showRange(),this.map.entity_range},t.prototype.hideRange=function(){this.entity_manager.hideRange()},t.prototype.attackEntity=function(t,e){this.entity_manager.attackEntity(t,e)},t.prototype.raiseEntity=function(t,e){this.entity_manager.raiseEntity(t,e)},t.prototype.deselectEntity=function(t){this.selected_entity&&(this.cursor_target=this.selected_entity.position.copy(),this.hideRange(),this.entity_manager.deselectEntity(this.selected_entity),this.selected_entity=null,t&&(this.map.resetWisp(this.turn),this.entity_manager.showWisped(),this.frame_def_info.updateContent(this.cursor_target,this.map)))},t.prototype.startTurn=function(t){this.turn=t;var e=this.players[t-1];e.start(),this.cursor_target=e.getCursorPosition();var i=this.cursor_target.getWorldPosition();this.cursor.setWorldPosition(i),this.frame_gold_info.updateContent(t,this.getGoldForAlliance(t))},t.prototype.updateOffsetForPosition=function(t){var e=t.x+.5*AncientEmpires.TILE_SIZE,i=t.y+.5*AncientEmpires.TILE_SIZE;this.updateOffset(e,i)},t.prototype.updateOffset=function(t,e){var i,s,n=this.getOffsetX(t),o=this.getOffsetY(e),a=n-this.camera.x,r=o-this.camera.y;this.camera_still=0==a&&0==r,0!=a&&(i=(i=Math.floor(a/12))<0?(i=Math.max(i,-4),Math.min(i,-1)):(i=Math.min(i,4),Math.max(i,1)),this.camera.x+=i),0!=r&&(s=(s=Math.floor(r/12))<0?(s=Math.max(s,-4),Math.min(s,-1)):(s=Math.min(s,4),Math.max(s,1)),this.camera.y+=s)},t.prototype.getOffsetX=function(t){var e=t-this.game.width/2;return e=this.game.width<this.world.width?(e=Math.max(e,0),Math.min(e,this.world.width-this.game.width)):(this.game.width-this.world.width)/2},t.prototype.getOffsetY=function(t){var e=t-this.game.height/2;return e=this.game.height<this.world.height?(e=Math.max(e,0),Math.min(e,this.world.height-this.game.height)):(this.game.height-this.world.height)/2},t}(Phaser.State),PNGWaiter=function(){function t(t){var e=this;this.ret=function(){e.counter--,0<e.counter||!e.awaiting||e.callback()},this.counter=0,this.awaiting=!1,this.callback=t}return t.prototype.await=function(){this.awaiting=!0,this.counter<=0&&this.callback()},t.prototype.add=function(){this.counter++},t}(),PNGLoader=function(){function m(){}return m.bufferToBase64=function(t){var e=Array.prototype.map.call(t,function(t){return String.fromCharCode(t)}).join("");return btoa(e)},m.loadSpriteSheet=function(t,n,o,a,e,r){var i,s,h,c=n;if(void 0!==o&&void 0!==a&&void 0!==e||(i=AncientEmpires.game.cache.getBinary(n+".sprite"),s=new DataView(i),void(h=0)===e&&(e=s.getUint8(h++)),void 0===o&&(o=s.getUint8(h++)),void 0===a&&(a=s.getUint8(h++))),AncientEmpires.game.cache.checkBinaryKey(n+".png")){var p=AncientEmpires.game.cache.getBinary(n+".png");void 0!==r&&(p=m.createVariation(p,r),c+="_"+r);var l=new Image;t.add(),l.onload=function(){AncientEmpires.game.cache.addSpriteSheet(c,null,l,o,a),t.ret()},l.src="data:image/png;base64,"+m.bufferToBase64(new Uint8Array(p))}else{t.add();for(var u=new PNGWaiter(t.ret),g=Math.ceil(Math.sqrt(e)),d=AncientEmpires.game.add.bitmapData(g*o,g*a),y=0;y<e;y++)!function(t){var e=t<10?"_0"+t:"_"+t,i=AncientEmpires.game.cache.getBinary(n+e+".png");void 0!==r&&(i=m.createVariation(i,r),c+="_"+r);var s=new Image;u.add(),s.onload=function(){d.ctx.drawImage(s,t%g*o,Math.floor(t/g)*a),u.ret()},s.src="data:image/png;base64,"+m.bufferToBase64(new Uint8Array(i))}(y);u.await(),AncientEmpires.game.cache.addSpriteSheet(c,null,d.canvas,o,a,e)}},m.loadImage=function(t,e){var i=AncientEmpires.game.cache.getBinary(e+".png"),s=new Image;t.add(),s.onload=function(){AncientEmpires.game.cache.addImage(e,null,s),t.ret()},s.src="data:image/png;base64,"+m.bufferToBase64(new Uint8Array(i))},m.createVariation=function(t,e){if(void 0===e)return t;t=t.slice(0);for(var i=new DataView(t),s=0,n=0;s<i.byteLength-3;s++)if(80==i.getUint8(s)&&76==i.getUint8(s+1)&&84==i.getUint8(s+2)){n=s-4;break}s=n;var o=i.getUint32(s);s+=4;for(var a=-1,r=0;r<4;r++)a=m.updatePNGCRC(i.getUint8(s+r),a);for(r=s+=4;r<s+o;r+=3){var h,c=i.getUint8(r),p=i.getUint8(r+1),l=i.getUint8(r+2);c<l&&p<l&&(2==e?(h=c,c=l,l=h,p/=2):0==e&&(p=c=l),i.setUint8(r,c),i.setUint8(r+1,p),i.setUint8(r+2,l)),a=m.updatePNGCRC(i.getUint8(r),a),a=m.updatePNGCRC(i.getUint8(r+1),a),a=m.updatePNGCRC(i.getUint8(r+2),a)}a^=-1;var u=n+8+o;return i.setUint32(u,a),t},m.updatePNGCRC=function(t,e){e^=255&t;for(var i=0;i<8;i++)0==(1&e)?e>>>=1:e=e>>>1^-306674912;return e},m}(),Loader=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.preload=function(){this.game.scale.scaleMode=Phaser.ScaleManager.USER_SCALE,this.game.scale.setUserScale(2,2),this.game.load.bitmapFont("font7","assets/font.png","assets/font.xml"),this.game.load.binary("data","assets/1.pak",function(t,e){return new Uint8Array(e)}),this.game.load.binary("lang","assets/lang.dat",function(t,e){return new Uint8Array(e)})},e.prototype.create=function(){var t=this;this.unpackResourceData(),this.loadEntityData(),this.loadMapTilesProp(),this.unpackLangData();var e=new PNGWaiter(function(){t.game.state.start("MainMenu",!1,!1,name)});PNGLoader.loadImage(e,"splash"),PNGLoader.loadImage(e,"splashbg"),PNGLoader.loadImage(e,"splashfg"),PNGLoader.loadSpriteSheet(e,"tiles0",24,24),PNGLoader.loadSpriteSheet(e,"stiles0",10,10),PNGLoader.loadSpriteSheet(e,"buildings",24,24,3,0),PNGLoader.loadSpriteSheet(e,"buildings",24,24,3,1),PNGLoader.loadSpriteSheet(e,"buildings",24,24,3,2),PNGLoader.loadSpriteSheet(e,"unit_icons",24,24,0,1),PNGLoader.loadSpriteSheet(e,"unit_icons",24,24,0,2),PNGLoader.loadSpriteSheet(e,"unit_icons_s",10,10,0,1),PNGLoader.loadSpriteSheet(e,"unit_icons_s",10,10,0,2),PNGLoader.loadSpriteSheet(e,"cursor",26,26),PNGLoader.loadSpriteSheet(e,"b_smoke"),PNGLoader.loadSpriteSheet(e,"menu"),PNGLoader.loadSpriteSheet(e,"portrait"),PNGLoader.loadSpriteSheet(e,"chars"),PNGLoader.loadImage(e,"gold"),PNGLoader.loadImage(e,"pointer"),PNGLoader.loadSpriteSheet(e,"redspark"),PNGLoader.loadSpriteSheet(e,"spark"),PNGLoader.loadSpriteSheet(e,"smoke"),PNGLoader.loadSpriteSheet(e,"status"),PNGLoader.loadSpriteSheet(e,"road",24,24),PNGLoader.loadSpriteSheet(e,"grass",24,24),PNGLoader.loadSpriteSheet(e,"mountain",24,24),PNGLoader.loadSpriteSheet(e,"water",24,24),PNGLoader.loadSpriteSheet(e,"town",24,24),PNGLoader.loadImage(e,"woods_bg"),PNGLoader.loadImage(e,"hill_bg"),PNGLoader.loadImage(e,"mountain_bg"),PNGLoader.loadImage(e,"bridge_bg"),PNGLoader.loadImage(e,"town_bg"),PNGLoader.loadImage(e,"tombstone"),PNGLoader.loadImage(e,"mask"),e.await()},e.prototype.unpackResourceData=function(){var t=this.game.cache.getBinary("data"),e=new DataView(t.buffer),i=2,s=e.getUint16(i);i+=2;for(var n=[],o=0;o<s;o++){var a=e.getUint16(i);i+=2;for(var r="",h=0;h<a;h++)r+=String.fromCharCode(e.getUint8(i++));i+=4;var c=e.getUint16(i);i+=2,n.push({name:r,size:c})}for(var p=0,l=n;p<l.length;p++){var u=l[p],g=t.buffer.slice(i,i+u.size);this.game.cache.addBinary(u.name,g),i+=u.size}},e.prototype.loadEntityData=function(){var t=this.game.cache.getBinary("units.bin"),e=new DataView(t),i=0;AncientEmpires.ENTITIES=[];for(var s=["Soldier","Archer","Lizard","Wizard","Wisp","Spider","Golem","Catapult","Wyvern","King","Skeleton"],n=0;n<s.length;n++){var o={name:s[n],mov:e.getUint8(i++),atk:e.getUint8(i++),def:e.getUint8(i++),max:e.getUint8(i++),min:e.getUint8(i++),cost:e.getUint16(i),battle_positions:[],flags:EntityFlags.None};i+=2;for(var a=e.getUint8(i++),r=0;r<a;r++)o.battle_positions.push({x:e.getUint8(i++),y:e.getUint8(i++)});for(var h=e.getUint8(i++),r=0;r<h;r++)o.flags|=1<<e.getUint8(i++);AncientEmpires.ENTITIES.push(o)}},e.prototype.loadMapTilesProp=function(){var t=this.game.cache.getBinary("tiles0.prop"),e=new DataView(t),i=0,s=e.getUint16(i);i+=4,AncientEmpires.TILES_PROP=[];for(var n=0;n<s;n++)AncientEmpires.TILES_PROP.push(e.getUint8(i++))},e.prototype.unpackLangData=function(){var t=this.game.cache.getBinary("lang"),e=new DataView(t.buffer),i=0,s=e.getUint32(i);i+=4,AncientEmpires.LANG=[];for(var n=0;n<s;n++){var o=e.getUint16(i);i+=2;for(var a="",r=0;r<o;r++)a+=String.fromCharCode(e.getUint8(i++));AncientEmpires.LANG.push(a)}},e}(Phaser.State),Pos=function(){function e(t,e){this.x=t,this.y=e}return e.prototype.match=function(t){return!!t&&this.x==t.x&&this.y==t.y},e.prototype.copy=function(t){switch(void 0===t&&(t=Direction.None),t){case Direction.Up:return new e(this.x,this.y-1);case Direction.Right:return new e(this.x+1,this.y);case Direction.Down:return new e(this.x,this.y+1);case Direction.Left:return new e(this.x-1,this.y)}return new e(this.x,this.y)},e.prototype.move=function(t){switch(t){case Direction.Up:this.y--;break;case Direction.Right:this.x++;break;case Direction.Down:this.y++;break;case Direction.Left:this.x--}return this},e.prototype.distanceTo=function(t){return Math.abs(t.x-this.x)+Math.abs(t.y-this.y)},e.prototype.getDirectionTo=function(t){return t.x>this.x?Direction.Right:t.x<this.x?Direction.Left:t.y>this.y?Direction.Down:t.y<this.y?Direction.Up:Direction.None},e.prototype.getWorldPosition=function(){return new e(this.x*AncientEmpires.TILE_SIZE,this.y*AncientEmpires.TILE_SIZE)},e.prototype.getI=function(){return{x:this.x,y:this.y}},e}();!function(t){t[t.None=0]="None",t[t.Up=1]="Up",t[t.Right=2]="Right",t[t.Down=4]="Down",t[t.Left=8]="Left",t[t.All=15]="All"}(Direction=Direction||{}),function(t){t[t.CampaignMaps=0]="CampaignMaps",t[t.SkirmishMaps=1]="SkirmishMaps",t[t.SkirmishPlayers=2]="SkirmishPlayers"}(ActiveMenuType=ActiveMenuType||{});var MainMenu=function(t){function s(){return t.call(this)||this}return __extends(s,t),s.drawTransition=function(t,e,i,s,n){for(var o=Math.ceil(s/4),a=Math.ceil(n/2),r=e-6,h=0;h<4;h++){var c=Math.floor(t-2*h);if(c<=0)break;for(var p=void 0,l=void 0,l=r<=c?(p=o,a):(p=Math.floor(c*o/r),Math.floor(c*a/r)),u=Math.floor((o-p)/2),g=Math.floor((a-l)/2),d=h*o+u,y=0;y<2;y++){var m=y*a+g;i.drawRect(d,m,p,l)}}},s.loadGame=function(t){try{var e=localStorage.getItem("save.rs"),i=JSON.parse(e)}catch(t){return!1}return!!i&&(t.state.start("Game",!0,!1,i),!0)},s.startGame=function(t,e,i,s){void 0===s&&(s=[!0,!1]);var n={campaign:e,map:i,players:s};t.state.start("Game",!0,!1,n)},s.showAbout=function(t){var e=t.add.group();e.fixedToCamera=!0;var i=t.add.graphics(0,0,e);return i.beginFill(16777215),i.drawRect(0,0,t.width,t.height),i.endFill(),i.beginFill(0),i.drawRect(0,37,t.width,1),i.endFill(),t.add.bitmapText(10,26,"font7",AncientEmpires.LANG[8],7,e),t.add.bitmapText(10,42,"font7",AncientEmpires.LANG[0]+AncientEmpires.LANG[14],7,e).maxWidth=t.width-20,e},s.showInstructions=function(t,e){void 0===e&&(e=0),t.removeChildren();var i=t.game.add.graphics(0,0,t);i.beginFill(16777215),i.drawRect(0,0,t.game.width,t.game.height),i.endFill(),i.beginFill(0),i.drawRect(0,37,t.game.width,1),i.endFill(),t.game.add.bitmapText(10,26,"font7",AncientEmpires.LANG[7]+(0<e?" - "+e:""),7,t),t.game.add.bitmapText(10,42,"font7",AncientEmpires.LANG[0<e?86+e:13],7,t).maxWidth=t.game.width-20},s.prototype.openMenu=function(t){t==InputContext.Wait&&(this.notification_shown=!0)},s.prototype.closeMenu=function(t){t==InputContext.Wait&&(this.notification_shown=!1)},s.prototype.create=function(){this.notification_shown=!1,this.intro=!0,this.intro_acc=0,this.intro_progress=0,this.game.add.image(0,0,"splashbg"),this.knights=this.game.add.image(0,26,"splashfg"),this.title=this.game.add.image(0,8,"splash"),this.title.x=Math.floor((this.game.width-this.title.width)/2),this.title.visible=!1,this.title_mask=this.game.add.graphics(this.title.x,this.title.y),this.title.mask=this.title_mask;var t=this.game.add.group();this.frame_manager=new FrameManager(t),this.keys=new Input(this.game.input)},s.prototype.update=function(){if(this.intro)this.intro_acc++,this.intro_acc<2||(this.intro_acc=0,this.intro_progress++,this.intro_progress<=30?this.knights.y=26-this.intro_progress:this.intro_progress<=60?(this.title.visible=!0,this.title_mask.clear(),this.title_mask.beginFill(),s.drawTransition(Math.ceil((this.intro_progress-30)/2),15,this.title_mask,this.title.width,this.title.height),this.title_mask.endFill()):(this.title_mask.clear(),this.main=new MenuOptions(this.frame_manager.group,Direction.None,MenuOptions.getMainMenuOptions(!1),this,Direction.Up),this.frame_manager.addFrame(this.main),this.main.show(!0,72),this.intro=!1));else{if(this.keys.update(),this.frame_manager.update(1),this.notification_shown)return;var t,e,i;this.keys.isKeyPressed(Key.Up)?(this.keys.clearKeyPressed(Key.Up),this.menu_select?this.menu_select.prev():this.main.prev()):this.keys.isKeyPressed(Key.Down)?(this.keys.clearKeyPressed(Key.Down),this.menu_select?this.menu_select.next():this.main.next()):this.keys.isKeyPressed(Key.Enter)?(this.keys.clearKeyPressed(Key.Enter),this.active_about?(this.active_about.destroy(!0),this.active_about=null):this.active_instructions?(e=this.active_instruction_nr+1)<=17&&(this.active_instruction_nr=e,s.showInstructions(this.active_instructions,this.active_instruction_nr)):this.menu_select?this.selectChoice(this.menu_select.selected):(t=this.main.getSelected(),this.executeAction(t))):this.keys.isKeyPressed(Key.Esc)?this.active_about?(this.active_about.destroy(!0),this.active_about=null):this.active_instructions?(this.active_instructions.destroy(!0),this.active_instructions=null):this.menu_select&&(this.menu_select.hide(!1,!0),this.menu_select=null,this.main.show(!0,72)):this.keys.isKeyPressed(Key.Right)?(this.keys.clearKeyPressed(Key.Right),this.active_instructions&&(e=this.active_instruction_nr+1)<=17&&(this.active_instruction_nr=e,s.showInstructions(this.active_instructions,this.active_instruction_nr))):this.keys.isKeyPressed(Key.Left)&&(this.keys.clearKeyPressed(Key.Left),!this.active_instructions||0<=(i=this.active_instruction_nr-1)&&(this.active_instruction_nr=i,s.showInstructions(this.active_instructions,this.active_instruction_nr)))}},s.prototype.showMessage=function(t){var e=new NotificationFrame(this.frame_manager.group,t,this);this.frame_manager.addFrame(e),e.show(!0)},s.prototype.executeAction=function(t){switch(t){case Action.LOAD_GAME:s.loadGame(this.game)?this.main.hide(!1):this.showMessage(AncientEmpires.LANG[43]);break;case Action.NEW_GAME:this.main.hide(!1),s.startGame(this.game,!1,0);break;case Action.SELECT_LEVEL:for(var e=[],i=0;i<7;i++)e.push(AncientEmpires.LANG[49+i]);this.main.hide(!1),this.active_select=ActiveMenuType.CampaignMaps,this.menu_select=new MenuSelect(e,this.frame_manager.group,this,Direction.None,Direction.Up),this.frame_manager.addFrame(this.menu_select),this.menu_select.show(!0,72);break;case Action.SKIRMISH:this.main.hide(!1),this.active_select=ActiveMenuType.SkirmishMaps,this.menu_select=new MenuSelect(["Island Cross","Rocky Bay"],this.frame_manager.group,this,Direction.None,Direction.Up),this.frame_manager.addFrame(this.menu_select),this.menu_select.show(!0,72);break;case Action.ABOUT:this.active_about=s.showAbout(this.game);break;case Action.INSTRUCTIONS:this.active_instructions=this.game.add.group(),this.active_instruction_nr=0,s.showInstructions(this.active_instructions)}},s.prototype.selectChoice=function(t){switch(this.menu_select.hide(!1,!0),this.menu_select=null,this.active_select){case ActiveMenuType.CampaignMaps:s.startGame(this.game,!0,t);break;case ActiveMenuType.SkirmishMaps:this.active_skirmish=t,this.active_select=ActiveMenuType.SkirmishPlayers,this.menu_select=new MenuSelect(["1 PLAYER","2 PLAYER","AI ONLY"],this.frame_manager.group,this,Direction.None,Direction.Up),this.frame_manager.addFrame(this.menu_select),this.menu_select.show(!0,72);break;case ActiveMenuType.SkirmishPlayers:var e=[2!=t,1==t];s.startGame(this.game,!1,this.active_skirmish,e)}},s}(Phaser.State),AncientEmpires=function(){function e(t){this.width=176,this.height=204,e.game=new Phaser.Game(this.width,this.height,Phaser.AUTO,t,this,!1,!1),this.loader=new Loader,this.mainMenu=new MainMenu,this.controller=new GameController,e.game.state.add("Loader",this.loader),e.game.state.add("MainMenu",this.mainMenu),e.game.state.add("Game",this.controller),e.game.state.start("Loader")}return e.TILE_SIZE=24,e.MINI_SIZE=10,e.LINE_SEGMENT_LENGTH=10,e.LINE_SEGMENT_WIDTH=4,e.LINE_SEGMENT_SPACING=2,e.DEATH_COUNT=3,e.NUMBER_OF_TILES=23,e}();function launch(){new AncientEmpires("content")}window.onload=launch;